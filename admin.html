<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Crossflag · Admin</title>

<style>
:root{
  --bg:#0b1220;--card:#0f1a30;--border:#223255;
  --text:#e9f0ff;--muted:#9fb0d4;
  --btn:#2563eb;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
body{margin:0;background:var(--bg);color:var(--text)}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
h1{font-size:18px;margin:0 0 10px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
label{font-size:12px;color:var(--muted)}
input,select{
  background:#0002;color:var(--text);border:1px solid var(--border);
  border-radius:10px;padding:8px 10px
}
button{
  border:0;border-radius:10px;padding:8px 12px;
  font-weight:900;cursor:pointer;color:#fff;background:var(--btn)
}
button.ok{background:var(--ok)}
button.bad{background:var(--bad)}
button.warn{background:var(--warn);color:#111}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ffffff14;vertical-align:top}
th{font-size:12px;color:var(--muted);text-align:left}
.mono{font-family:ui-monospace,monospace}
.small{font-size:12px;color:var(--muted)}
a{color:#9fb0d4}
</style>
</head>

<body>
<div class="wrap">
<h1>Crossflag · Admin</h1>

<div class="card">
<div class="row">
<div>
<label>Admin token</label>
<input id="token">
</div>
<button onclick="saveToken()">Save</button>
</div>
</div>

<div class="card">
<h1>BUY заявки</h1>

<div class="row">
<input id="amountRub" placeholder="RUB">
<input id="rate" placeholder="Rate">
<input id="payBank" placeholder="Банк">
<input id="payReq" placeholder="Реквизиты">
<button onclick="addBuy()">Add</button>
<button onclick="loadBuy()">Refresh</button>
</div>

<table>
<thead>
<tr>
<th>ID</th>
<th>RUB</th>
<th>Rate</th>
<th>Status</th>
<th>Proof</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="buyBody"></tbody>
</table>
</div>
</div>

<script>
const API="https://rapira-rates-proxy.kireeshka73.workers.dev";

function tok(){return localStorage.admin_token||""}
function saveToken(){localStorage.admin_token=token.value}

async function api(path,opts={}){
  const h=opts.headers||{};
  if(tok())h["X-Admin-Token"]=tok();
  if(opts.method && opts.method!=="GET")h["Content-Type"]="application/json";
  const r=await fetch(API+path,{...opts,headers:h});
  const j=await r.json();
  if(!j.ok)throw j.error;
  return j;
}

function esc(s){return String(s||"").replace(/[<>&]/g,m=>({ "<":"&lt;",">":"&gt;","&":"&amp;" }[m]))}

function tgLink(tg){
  if(!tg)return"";
  const cid=String(tg.chatId).replace("-100","");
  return `https://t.me/c/${cid}/${tg.messageId}`;
}

function renderProof(o){
  if(!o.checkInfo)return"—";
  let h=`Банк: <b>${esc(o.checkInfo.bankFrom)}</b><br>`;
  h+=`Тип: <b>${esc(o.checkInfo.proofType)}</b>`;
  if(o.checkInfo.alphaLink){
    h+=`<br>Разделение: <a href="${esc(o.checkInfo.alphaLink)}" target="_blank">open</a>`;
  }
  if(o.checkInfo.files){
    h+="<br>Files:";
    for(const f of o.checkInfo.files){
      if(f.tg){
        h+=`<br><a href="${tgLink(f.tg)}" target="_blank">${esc(f.name)}</a>`;
      }
    }
  }
  return h;
}

async function loadBuy(){
  const j=await api("/api/admin/offers");
  buyBody.innerHTML="";
  for(const o of j.offers){
    const tr=document.createElement("tr");
    tr.innerHTML=`
<td class="mono">${o.id}</td>
<td>${o.amountRub}</td>
<td>${o.rate}</td>
<td>${o.status}</td>
<td class="small">${renderProof(o)}</td>
<td></td>`;
    const td=tr.lastElementChild;

    if(o.status==="ON_CHECK"){
      const ok=document.createElement("button");
      ok.textContent="SUCCESS";
      ok.className="ok";
      ok.onclick=()=>setStatus(o.id,"SUCCESS");
      td.appendChild(ok);

      const bad=document.createElement("button");
      bad.textContent="FAILED";
      bad.className="bad";
      bad.onclick=()=>setStatus(o.id,"FAILED");
      td.appendChild(bad);
    }

    const del=document.createElement("button");
    del.textContent="DEL";
    del.className="warn";
    del.onclick=()=>delBuy(o.id);
    td.appendChild(del);

    buyBody.appendChild(tr);
  }
}

async function addBuy(){
  await api("/api/admin/offers",{method:"POST",body:JSON.stringify({
    amountRub:amountRub.value,
    rate:rate.value,
    method:"SBP",
    payBank:payBank.value,
    payRequisite:payReq.value
  })});
  loadBuy();
}

async function setStatus(id,s){
  await api("/api/admin/offers/"+id,{method:"PATCH",body:JSON.stringify({status:s})});
  loadBuy();
}

async function delBuy(id){
  await api("/api/admin/offers/"+id,{method:"DELETE"});
  loadBuy();
}

token.value=tok();
loadBuy();
setInterval(loadBuy,5000);
</script>
</body>
</html>
