<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Crossflag · Подтверждение оплаты</title>

  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --border:#223255; --text:#e9f0ff;
      --muted:#9fb0d4; --ok:#9dffb8; --bad:#ffb4b4; --btn:#2563eb;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:18px; }
    .top{ display:flex; justify-content:space-between; align-items:center; }
    .title{ font-weight:900; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; }
    .pad{ padding:16px; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    .cell{ border:1px solid var(--border); border-radius:14px; padding:12px; }
    .k{ color:var(--muted); font-size:12px; }
    .v{ font-weight:900; }
    select,input{ width:100%; background:#0002; color:var(--text); border:1px solid var(--border); border-radius:12px; padding:10px; }
    .block{ border:1px solid var(--border); border-radius:14px; padding:12px; margin-top:12px; background:#0002; }
    .hidden{ display:none; }
    .btn{ background:var(--btn); color:#fff; border:0; border-radius:14px; padding:12px 16px; font-weight:900; cursor:pointer; }
    .btnRow{ display:flex; justify-content:flex-end; margin-top:12px; }
    .status{ margin-top:10px; font-size:13px; }
    .ok{ color:var(--ok); }
    .bad{ color:var(--bad); }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title">Crossflag · Подтверждение оплаты</div>
    <button class="btn" onclick="history.back()">Назад</button>
  </div>

  <div class="card">
    <div class="pad">
      <div class="grid">
        <div class="cell"><div class="k">Ордер</div><div class="v" id="oid">—</div></div>
        <div class="cell"><div class="k">Сумма</div><div class="v" id="amount">—</div></div>
        <div class="cell"><div class="k">Курс</div><div class="v" id="rate">—</div></div>
        <div class="cell"><div class="k">Получите</div><div class="v" id="usdt">—</div></div>
      </div>

      <div class="status" id="status"></div>

      <label style="margin-top:14px">Банк отправителя</label>
      <select id="bankSelect"></select>

      <div class="block" id="hint">Выбери банк — появится форма подтверждения</div>

      <div class="block hidden" id="alfa">
        <label>Ссылка разделения платежа</label>
        <input id="alfaLink">
        <label>PDF чек</label>
        <input type="file" id="alfaPdf" accept="application/pdf">
        <div class="btnRow"><button class="btn" onclick="sendAlfa()">Отправить</button></div>
      </div>

      <div class="block hidden" id="sber">
        <label>PDF чек</label><input type="file" id="sber1" accept="application/pdf">
        <label>PDF выписка</label><input type="file" id="sber2" accept="application/pdf">
        <div class="btnRow"><button class="btn" onclick="sendSber()">Отправить</button></div>
      </div>

      <div class="block hidden" id="other">
        <label>PDF чек</label><input type="file" id="oPdf" accept="application/pdf">
        <label>Видео</label><input type="file" id="oVid" accept="video/*">
        <div class="btnRow"><button class="btn" onclick="sendOther()">Отправить</button></div>
      </div>
    </div>
  </div>
</div>

<script>
const API = "https://rapira-rates-proxy.kireeshka73.workers.dev";
const p = new URLSearchParams(location.search);
const id = p.get("id");
const reserveId = p.get("reserveId");

oid.textContent = id;
amount.textContent = p.get("amountRub")+" ₽";
rate.textContent = p.get("rate");
usdt.textContent = (p.get("amountRub")/p.get("rate")).toFixed(6)+" USDT";

const banks = ["Сбербанк","Альфа-Банк","Т-банк","Совкомбанк","ВТБ","Другой"];
bankSelect.innerHTML = '<option value="">Выбери банк</option>' + banks.map(b=>`<option>${b}</option>`).join("");

bankSelect.onchange = () => {
  alfa.classList.add("hidden");
  sber.classList.add("hidden");
  other.classList.add("hidden");
  hint.classList.add("hidden");

  const b = bankSelect.value.toLowerCase();
  if (b.includes("альфа")) alfa.classList.remove("hidden");
  else if (b.includes("сбер")) sber.classList.remove("hidden");
  else other.classList.remove("hidden");
};

async function submit(fd){
  const r = await fetch(API+"/api/public/submit_proof",{method:"POST",body:fd});
  const j = await r.json();
  if(!j.ok) throw j.error;
  location.href = "./check.html?id="+id+"&reserveId="+reserveId;
}

async function sendAlfa(){
  const fd=new FormData();
  fd.append("id",id);
  fd.append("reserveId",reserveId);
  fd.append("bankFrom",bankSelect.value);
  fd.append("proofType","ALFA");
  fd.append("alphaLink",alfaLink.value);
  fd.append("pdf1",alfaPdf.files[0]);
  await submit(fd);
}

async function sendSber(){
  const fd=new FormData();
  fd.append("id",id);
  fd.append("reserveId",reserveId);
  fd.append("bankFrom",bankSelect.value);
  fd.append("proofType","SBER");
  fd.append("pdf1",sber1.files[0]);
  fd.append("pdf2",sber2.files[0]);
  await submit(fd);
}

async function sendOther(){
  const fd=new FormData();
  fd.append("id",id);
  fd.append("reserveId",reserveId);
  fd.append("bankFrom",bankSelect.value);
  fd.append("proofType","OTHER");
  fd.append("pdf1",oPdf.files[0]);
  fd.append("video",oVid.files[0]);
  await submit(fd);
}
</script>
</body>
</html>
