<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Crossflag · Admin</title>
  <style>
    :root{
      --bg:#071022;
      --card: rgba(15, 26, 48, 0.52);
      --border: rgba(255,255,255,.12);
      --text:#e9f0ff;
      --muted:#9fb0d4;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --btn:#2d5bff;
      --btn2:#1f3fb3;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      padding:16px;
    }
    .wrap{ max-width:1200px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-bottom:12px;
    }
    h1{ margin:0 0 10px; font-size:18px; font-weight:1000; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-weight:900;
      outline:none;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:1000;
      color:#fff;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
    }
    .btn.warn{ background: rgba(245,158,11,.18); border:1px solid rgba(245,158,11,.35); color:#fff; }
    .btn.ok{ background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.35); color:#fff; }
    .btn.danger{ background: rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); color:#fff; }
    .muted{ color:var(--muted); font-size:12px; font-weight:850; }
    table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    th{ text-align:left; font-size:12px; color:var(--muted); font-weight:1000; padding:0 10px; }
    td{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
      font-size:13px;
      font-weight:900;
      vertical-align:top;
    }
    tr td:first-child{ border-radius:14px 0 0 14px; }
    tr td:last-child{ border-radius:0 14px 14px 0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; overflow-wrap:anywhere; word-break:break-word; font-weight:900; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .pill.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .pill.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .small{ font-size:12px; font-weight:850; color: rgba(233,240,255,.80); }
    .txWrap{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .txInput{ flex:1 1 240px; }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <h1>Admin</h1>
      <div class="row">
        <div class="muted">Worker:</div>
        <div class="mono" id="w"></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="token" placeholder="ADMIN_TOKEN" style="min-width:280px;">
        <button class="btn" id="saveTokenBtn" type="button">Сохранить токен</button>
        <div class="muted" id="authStatus">—</div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h1 style="margin:0;">Заявки BUY</h1>
        <button class="btn" id="refreshBuyBtn" type="button">Обновить</button>
      </div>
      <div class="muted" id="buyStatus" style="margin-top:6px;">—</div>

      <table style="margin-top:10px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Сумма</th>
            <th>Курс</th>
            <th>Метод</th>
            <th>Статус</th>
            <th>Кошелёк</th>
            <th>Доказательства</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody id="buyTbody"></tbody>
      </table>
    </div>

  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";
  document.getElementById("w").textContent = WORKER_BASE;

  const tokenInput = document.getElementById("token");
  const authStatus = document.getElementById("authStatus");
  const buyStatus = document.getElementById("buyStatus");
  const buyTbody = document.getElementById("buyTbody");

  function getToken(){ return localStorage.getItem("admin_token") || ""; }
  function setToken(t){ localStorage.setItem("admin_token", t); }

  tokenInput.value = getToken();

  document.getElementById("saveTokenBtn").onclick = () => {
    setToken(tokenInput.value.trim());
    authStatus.textContent = "Токен сохранён";
  };

  async function api(path, opt = {}){
    const headers = opt.headers || {};
    headers["Content-Type"] = headers["Content-Type"] || "application/json";
    headers["X-Admin-Token"] = getToken();
    const res = await fetch(WORKER_BASE + path, { ...opt, headers });
    const txt = await res.text();
    let j;
    try{ j = JSON.parse(txt); }catch{ throw new Error("Ответ не JSON: " + txt.slice(0,200)); }
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  function pillForStatus(st){
    st = String(st||"NEW").toUpperCase();
    const cls = (st === "SUCCESS") ? "ok" : (st === "FAILED") ? "bad" : "warn";
    return `<span class="pill ${cls}">${st}</span>`;
  }

  function fmtWallet(o){
    const w = o.wallet;
    if (!w || !w.type || !w.value) return "—";
    return `<div class="small"><b>${escapeHtml(w.type)}</b></div><div class="mono small">${escapeHtml(w.value)}</div>`;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function loadBuy(){
    try{
      buyStatus.textContent = "Загрузка…";
      const j = await api("/api/admin/offers", { method:"GET" });
      const offers = j.offers || [];

      buyTbody.innerHTML = "";

      for (const o of offers){
        const st = String(o.status || "NEW").toUpperCase();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="mono">${escapeHtml(o.id)}</td>
          <td>${Number(o.amountRub||0).toLocaleString("ru-RU")} ₽</td>
          <td>${Number(o.rate||0).toLocaleString("ru-RU",{maximumFractionDigits:2})}</td>
          <td>${escapeHtml(o.method||"")}</td>
          <td>${pillForStatus(st)}</td>
          <td>${fmtWallet(o)}</td>
          <td>
            ${o.checkInfo ? (
              `<div class="small"><b>${escapeHtml(o.checkInfo.bankFrom||"")}</b></div>
               <div class="small">${escapeHtml(o.checkInfo.proofType||"")}</div>
               ${o.checkInfo.alphaLink ? `<div class="mono small">${escapeHtml(o.checkInfo.alphaLink)}</div>` : ""}`
            ) : "—"}
          </td>
          <td></td>
        `;

        const td = tr.querySelector("td:last-child");

        const freezeBtn = document.createElement("button");
        freezeBtn.className = "btn warn";
        freezeBtn.textContent = o.frozen ? "Разморозить" : "Заморозить";
        freezeBtn.onclick = async () => {
          await api(`/api/admin/offers/${o.id}`, { method:"PATCH", body: JSON.stringify({ frozen: !o.frozen }) });
          await loadBuy();
        };
        td.appendChild(freezeBtn);

        if (st === "ON_CHECK") {
          const okBtn = document.createElement("button");
          okBtn.className = "btn ok";
          okBtn.style.marginLeft = "8px";
          okBtn.textContent = "Успешно";
          okBtn.onclick = async () => {
            await api(`/api/admin/offers/${o.id}`, { method:"PATCH", body: JSON.stringify({ status:"SUCCESS" }) });
            await loadBuy();
          };
          td.appendChild(okBtn);

          const failBtn = document.createElement("button");
          failBtn.className = "btn danger";
          failBtn.style.marginLeft = "8px";
          failBtn.textContent = "Неуспешно";
          failBtn.onclick = async () => {
            await api(`/api/admin/offers/${o.id}`, { method:"PATCH", body: JSON.stringify({ status:"FAILED" }) });
            await loadBuy();
          };
          td.appendChild(failBtn);
        }

        // ✅ TX HASH UI (when SUCCESS)
        if (st === "SUCCESS") {
          const wrap = document.createElement("div");
          wrap.className = "txWrap";

          const inp = document.createElement("input");
          inp.className = "txInput";
          inp.placeholder = "txHash (вставь хэш транзакции)";
          inp.value = o.txHash || "";
          wrap.appendChild(inp);

          const save = document.createElement("button");
          save.className = "btn";
          save.textContent = "Сохранить";
          save.onclick = async () => {
            save.disabled = true;
            save.textContent = "Сохраняю…";
            try{
              await api(`/api/admin/offers/${o.id}`, { method:"PATCH", body: JSON.stringify({ txHash: inp.value.trim() }) });
              await loadBuy();
            }finally{
              save.disabled = false;
              save.textContent = "Сохранить";
            }
          };
          wrap.appendChild(save);

          td.appendChild(wrap);
        }

        buyTbody.appendChild(tr);
      }

      buyStatus.textContent = "Загружено: " + offers.length;
    }catch(e){
      buyStatus.textContent = "Ошибка: " + (e.message || String(e));
    }
  }

  document.getElementById("refreshBuyBtn").onclick = loadBuy;

  loadBuy();
  setInterval(loadBuy, 4000);
</script>
</body>
</html>
