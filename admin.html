<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админка обменника</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --border:#223255;
      --text:#e9f0ff; --muted:#9fb0d4;
      --btn:#2563eb; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .top{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .title{ font-weight:950; font-size:18px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .small{ color:var(--muted); font-size:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:12px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid{ grid-template-columns: 1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:#0b1430;
      color:var(--text);
      padding:10px 10px;
      outline:none;
      font-weight:800;
      font-size:13px;
    }
    textarea{ min-height:70px; resize:vertical; }
    button{
      border:0; border-radius:10px;
      padding:10px 12px;
      background:var(--btn);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    button:disabled{ opacity:.65; cursor:not-allowed; }
    .miniBtn{
      padding:8px 10px;
      font-size:12px;
      border:1px solid var(--border);
      background:transparent;
    }
    .pill{
      display:inline-block; padding:4px 10px;
      border-radius:999px; border:1px solid var(--border);
      font-size:12px; font-weight:900; color:var(--muted);
    }
    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid rgba(255,255,255,.06); padding:10px 8px; vertical-align:top; }
    th{ text-align:left; font-size:12px; color:var(--muted); }
    td{ font-size:13px; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btnOk{ background:var(--ok); }
    .btnBad{ background:var(--danger); }
    .btnWarn{ background:var(--warn); color:#111; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Админка обменника</div>
      <div class="row" style="gap:10px; align-items:center;">
        <div class="small">Worker: <span id="w"></span></div>
        <button class="miniBtn" id="openDealLink" type="button">Ссылки сделок</button>
        <button class="miniBtn" id="openAttempts" type="button">Логи сделок</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:950; margin-bottom:8px;">Авторизация</div>
        <label>Admin token (X-Admin-Token) / Telegram WebApp</label>
        <input id="token" placeholder="вставь секретный токен из Cloudflare" />
        <div class="row" style="margin-top:10px;">
          <button id="saveToken">Сохранить токен</button>
          <span class="pill" id="authState">не авторизован</span>
        </div>
        <div class="small" style="margin-top:10px;">
          Токен хранится в localStorage (admin_token).
        </div>
      </div>

      <div class="card">
        <div style="font-weight:950; margin-bottom:8px;">Конфиг</div>
        <div class="row" style="gap:10px;">
          <div style="flex:1;">
            <label>buyPercent</label>
            <input id="buyPercent" type="number" step="0.01" />
          </div>
          <div style="flex:1;">
            <label>sellPercent</label>
            <input id="sellPercent" type="number" step="0.01" />
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="loadConfig">Загрузить</button>
          <button id="saveConfig">Сохранить</button>
        </div>
        <div class="small" style="margin-top:10px;">
          (Если ты реально Rapira не используешь — можешь не трогать этот блок.)
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:950;">BUY офферы</div>
          <div class="row">
            <button id="reloadBuy">Обновить</button>
          </div>
        </div>
        <div style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Сумма</th>
                <th>Метод</th>
                <th>Курс</th>
                <th>Банк/Реквизиты</th>
                <th>Статус</th>
                <th>TxHash/URL</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="tbodyBuy"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:950;">SELL офферы</div>
          <div class="row">
            <button id="reloadSell">Обновить</button>
          </div>
        </div>
        <div style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Метод</th>
                <th>Курс</th>
                <th>Мин. чек</th>
                <th>Время</th>
                <th>Статус</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="tbodySell"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";
  document.getElementById("w").textContent = WORKER_BASE;

  // ✅ Переход в deal-link.html без повторного ввода токена
  document.getElementById("openDealLink").onclick = () => {
    try {
      localStorage.setItem("worker_base", WORKER_BASE);
      sessionStorage.setItem("deal_link_return", location.href);
      location.href = "./deal-link.html?wb=" + encodeURIComponent(WORKER_BASE);
    } catch(e) {
      location.href = "./deal-link.html?wb=" + encodeURIComponent(WORKER_BASE);
    }
  };

  // ✅ Переход в admin-attempts.html (логи сделок)
  document.getElementById("openAttempts").onclick = () => {
    try {
      localStorage.setItem("worker_base", WORKER_BASE);
      sessionStorage.setItem("admin_attempts_return", location.href);
      location.href = "./admin-attempts.html";
    } catch(e) {
      location.href = "./admin-attempts.html";
    }
  };

  const tokenEl = document.getElementById("token");
  const authState = document.getElementById("authState");
  const buyPercentEl = document.getElementById("buyPercent");
  const sellPercentEl = document.getElementById("sellPercent");
  const tbodyBuy = document.getElementById("tbodyBuy");
  const tbodySell = document.getElementById("tbodySell");

  function getToken(){ return (localStorage.getItem("admin_token") || "").trim(); }
  function setAuth(ok){
    authState.textContent = ok ? "авторизован" : "не авторизован";
    authState.style.color = ok ? "var(--ok)" : "var(--muted)";
  }

  async function api(path, opts={}){
    const t = getToken();
    const headers = Object.assign({}, opts.headers||{}, { "X-Admin-Token": t });
    const res = await fetch(WORKER_BASE + path, Object.assign({}, opts, { headers }));
    const j = await res.json().catch(()=> ({}));
    if(!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  async function checkAuth(){
    try{
      await api("/api/admin/me");
      setAuth(true);
    }catch(e){
      setAuth(false);
    }
  }

  document.getElementById("saveToken").onclick = async () => {
    const t = (tokenEl.value || "").trim();
    localStorage.setItem("admin_token", t);
    await checkAuth();
  };

  tokenEl.value = getToken();
  checkAuth();

  // Config
  document.getElementById("loadConfig").onclick = async () => {
    try{
      const j = await api("/api/admin/config");
      buyPercentEl.value = j.config.buyPercent ?? 0;
      sellPercentEl.value = j.config.sellPercent ?? 0;
    }catch(e){ alert("Ошибка: " + e.message); }
  };
  document.getElementById("saveConfig").onclick = async () => {
    try{
      const body = { buyPercent: Number(buyPercentEl.value||0), sellPercent: Number(sellPercentEl.value||0) };
      await api("/api/admin/config", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      alert("Сохранено");
    }catch(e){ alert("Ошибка: " + e.message); }
  };

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[c]));
  }

  async function loadBuy(){
    const j = await api("/api/admin/offers");
    const offers = j.offers || [];
    tbodyBuy.innerHTML = offers.map(o => {
      const st = String(o.status||"NEW").toUpperCase();
      return `
        <tr>
          <td class="mono">${esc(o.id)}</td>
          <td>${esc(o.amountRub)}</td>
          <td>${esc(o.method)}</td>
          <td>${esc(o.rate)}</td>
          <td>${esc(o.payBank||"")}<br/><span class="mono">${esc(o.payRequisite||"")}</span></td>
          <td>${esc(st)}</td>
          <td class="mono">${esc(o.txHash||"")}</td>
          <td>
            <div class="actions">
              <button class="btnOk" data-act="ok" data-id="${esc(o.id)}">OK</button>
              <button class="btnWarn" data-act="oncheck" data-id="${esc(o.id)}">ON_CHECK</button>
              <button class="btnBad" data-act="del" data-id="${esc(o.id)}">DEL</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    tbodyBuy.querySelectorAll("button").forEach(btn=>{
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        try{
          if(act === "del"){
            await api("/api/admin/offers/" + encodeURIComponent(id), { method:"DELETE" });
          }else{
            const status = (act === "ok") ? "SUCCESS" : "ON_CHECK";
            await api("/api/admin/offers/" + encodeURIComponent(id), {
              method:"PATCH",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ status })
            });
          }
          await loadBuy();
        }catch(e){ alert("Ошибка: " + e.message); }
      };
    });
  }

  async function loadSell(){
    const j = await api("/api/admin/sell_offers");
    const offers = j.offers || [];
    tbodySell.innerHTML = offers.map(o => {
      const st = String(o.status||"NEW").toUpperCase();
      return `
        <tr>
          <td class="mono">${esc(o.id)}</td>
          <td>${esc(o.method)}</td>
          <td>${esc(o.rate)}</td>
          <td>${esc(o.minCheckRub)}</td>
          <td>${esc(o.avgTimeMin)} мин</td>
          <td>${esc(st)}</td>
          <td>
            <div class="actions">
              <button class="btnBad" data-act="del" data-id="${esc(o.id)}">DEL</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    tbodySell.querySelectorAll("button").forEach(btn=>{
      btn.onclick = async () => {
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        try{
          if(act === "del"){
            await api("/api/admin/sell_offers/" + encodeURIComponent(id), { method:"DELETE" });
          }
          await loadSell();
        }catch(e){ alert("Ошибка: " + e.message); }
      };
    });
  }

  document.getElementById("reloadBuy").onclick = () => loadBuy().catch(e=>alert("Ошибка: "+e.message));
  document.getElementById("reloadSell").onclick = () => loadSell().catch(e=>alert("Ошибка: "+e.message));

  loadBuy().catch(()=>{});
  loadSell().catch(()=>{});
</script>
</body>
</html>
