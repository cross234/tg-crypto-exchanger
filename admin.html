<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админка обменника</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --border:#223255;
      --text:#e9f0ff; --muted:#9fb0d4;
      --btn:#2563eb; --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .top{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
    .title{ font-weight:950; font-size:16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 18px 50px rgba(0,0,0,.35); }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:800; }
    input, select{
      width:100%; box-sizing:border-box; padding:10px 12px;
      border-radius:12px; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03); color:var(--text); font-weight:850; outline:none;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    .btn{
      border:0; border-radius:12px; padding:10px 14px; cursor:pointer;
      color:#fff; font-weight:950; background:var(--btn);
    }
    .btn.warn{ background:var(--warn); color:#111827; }
    .btn.danger{ background:var(--danger); }
    .btn.ok{ background:var(--ok); color:#052e16; }
    .btn.gray{ background:rgba(255,255,255,.10); }

    .status{ margin-top:10px; font-size:12px; color:var(--muted); white-space:pre-wrap; }
    .status.ok{ color:#9dffb8; font-weight:900; }
    .status.bad{ color:#ffb4b4; font-weight:900; }

    /* Таблица: защита от длинных строк */
    .tableWrap{ overflow:auto; border-radius:14px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; font-size:13px; min-width: 980px; }
    th, td{ padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; vertical-align:top; }
    th{ color:var(--muted); font-weight:950; }
    td{ max-width: 260px; }
    .tag{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); font-weight:900; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cfe0ff; }
    .small{ font-size:12px; color:var(--muted); }

    /* Ссылки "Открыть ..." */
    a.openLink{
      display:inline-block;
      max-width: 240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color:#cfe0ff;
      font-weight:900;
      text-decoration:none;
      vertical-align:bottom;
    }
    .fileLine{ margin:2px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Админка обменника</div>
      <div class="small">Worker: <span id="w"></span></div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:950; margin-bottom:8px;">Авторизация</div>
        <label>Admin token (X-Admin-Token)</label>
        <input id="token" placeholder="вставь секретный токен из Cloudflare" />
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="saveToken">Сохранить</button>
          <button class="btn gray" id="clearToken">Сбросить</button>
        </div>
        <div class="status" id="authStatus">Токен хранится локально.</div>
      </div>

      <div class="card">
        <div style="font-weight:950; margin-bottom:8px;">Настройка процентов</div>
        <div class="row">
          <div style="flex:1; min-width:180px;">
            <label>Покупка %</label>
            <input id="buyPercent" />
          </div>
          <div style="flex:1; min-width:180px;">
            <label>Продажа %</label>
            <input id="sellPercent" />
          </div>
          <button class="btn" id="saveConfig">Сохранить</button>
        </div>
        <div class="status" id="cfgStatus">—</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="font-weight:950;">Заявки</div>

      <div class="row" style="margin-top:10px;">
        <div style="flex:1; min-width:160px;">
          <label>Сумма (RUB)</label>
          <input id="amountRub" />
        </div>

        <div style="flex:1; min-width:150px;">
          <label>Метод</label>
          <select id="method">
            <option value="SBP">SBP (СБП)</option>
            <option value="CARD">CARD (Карта)</option>
          </select>
        </div>

        <div style="flex:1; min-width:160px;">
          <label>Курс</label>
          <input id="rate" />
        </div>

        <div style="flex:1; min-width:160px;">
          <label>Банк (Crossflag)</label>
          <input id="payBank" />
        </div>

        <div style="flex:1; min-width:220px;">
          <label>Реквизиты (Crossflag)</label>
          <input id="payRequisite" />
        </div>

        <button class="btn" id="addOffer">Добавить</button>
        <button class="btn gray" id="refresh">Обновить</button>
      </div>

      <div class="status" id="offerStatus">—</div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:140px;">ID</th>
              <th style="min-width:110px;">Сумма</th>
              <th style="min-width:80px;">Метод</th>
              <th style="min-width:90px;">Курс</th>
              <th style="min-width:120px;">Статус</th>
              <th style="min-width:220px;">Проверка</th>
              <th style="min-width:260px;">Файлы (Telegram)</th>
              <th style="min-width:260px;">Действия</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";
  document.getElementById("w").textContent = WORKER_BASE;

  const tokenInput = document.getElementById("token");
  const authStatus = document.getElementById("authStatus");
  const cfgStatus = document.getElementById("cfgStatus");
  const offerStatus = document.getElementById("offerStatus");

  const buyPercent = document.getElementById("buyPercent");
  const sellPercent = document.getElementById("sellPercent");

  const amountRub = document.getElementById("amountRub");
  const method = document.getElementById("method");
  const rate = document.getElementById("rate");
  const payBank = document.getElementById("payBank");
  const payRequisite = document.getElementById("payRequisite");

  const tbody = document.getElementById("tbody");

  function getToken(){ return localStorage.getItem("admin_token") || ""; }
  function setToken(t){ localStorage.setItem("admin_token", t); }
  tokenInput.value = getToken();

  document.getElementById("saveToken").onclick = () => {
    setToken(tokenInput.value.trim());
    authStatus.textContent = "Токен сохранён.";
    authStatus.className = "status ok";
  };
  document.getElementById("clearToken").onclick = () => {
    localStorage.removeItem("admin_token");
    tokenInput.value = "";
    authStatus.textContent = "Токен сброшен.";
    authStatus.className = "status";
  };

  async function api(path, opts = {}) {
    const headers = Object.assign({}, opts.headers || {});
    const t = getToken();
    if (t) headers["X-Admin-Token"] = t;
    if (!headers["Content-Type"] && opts.method && opts.method !== "GET") headers["Content-Type"] = "application/json";

    const res = await fetch(WORKER_BASE + path, { ...opts, headers });
    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch { throw new Error("Ответ не JSON: " + text.slice(0, 200)); }
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  function fmtRub(n){ return Number(n).toLocaleString("ru-RU") + " ₽"; }

  function safe(s){
    return (s || "").toString().replace(/[<>&]/g, c=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[c]));
  }

  function shortenName(name, max = 32){
    const n = (name || "").toString();
    if (n.length <= max) return n;
    const head = n.slice(0, Math.max(10, max - 12));
    const tail = n.slice(-8);
    return head + "…" + tail;
  }

  function statusRu(s){
    const m = { NEW:"Активна", PAID:"Оплачено", ON_CHECK:"На проверке", SUCCESS:"Успешно", FAILED:"Неуспешно" };
    return m[s] || s || "Активна";
  }

  function tgLink(chatId, messageId){
    const s = String(chatId || "");
    if (!s.startsWith("-100")) return "";
    const internal = s.slice(4);
    return "https://t.me/c/" + internal + "/" + String(messageId);
  }

  function renderCheck(o){
    const ci = o.checkInfo || null;
    if (!ci) return `<span class="small">—</span>`;
    return `
      <div class="small">
        Банк: <b>${safe(ci.bankFrom || "—")}</b><br/>
        Тип: <b>${safe(ci.proofType || "—")}</b><br/>
        ${ci.alphaLink ? `Ссылка: <span class="mono">${safe(ci.alphaLink)}</span><br/>` : ""}
      </div>
    `;
  }

  function renderFiles(o){
    const files = o?.checkInfo?.files || [];
    if (!files.length) return `<span class="small">—</span>`;

    return files.map(f => {
      const tg = f.tg || {};
      const link = tgLink(tg.chatId, tg.messageId);
      const full = (f.name || "").toString();
      const short = shortenName(full, 32);
      const label = `${safe(f.kind || "file")} · ${safe(short)}`;
      const title = safe(full);

      if (!link) return `<div class="small">Нет ссылки</div>`;

      return `
        <div class="fileLine">
          <a class="openLink" href="${link}" target="_blank" title="${title}">Открыть ${label}</a>
        </div>
      `;
    }).join("");
  }

  async function loadConfig(){
    try{
      cfgStatus.textContent = "Загружаю…";
      cfgStatus.className = "status";
      const j = await api("/api/admin/config", { method:"GET" });
      buyPercent.value = j.config.buyPercent;
      sellPercent.value = j.config.sellPercent;
      cfgStatus.textContent = "Загружено.";
      cfgStatus.className = "status ok";
    } catch(e){
      cfgStatus.textContent = "Ошибка: " + e.message;
      cfgStatus.className = "status bad";
    }
  }

  async function saveConfig(){
    try{
      cfgStatus.textContent = "Сохраняю…";
      cfgStatus.className = "status";
      await api("/api/admin/config", { method:"POST", body: JSON.stringify({ buyPercent: buyPercent.value, sellPercent: sellPercent.value }) });
      cfgStatus.textContent = "Сохранено.";
      cfgStatus.className = "status ok";
    } catch(e){
      cfgStatus.textContent = "Ошибка: " + e.message;
      cfgStatus.className = "status bad";
    }
  }

  async function addOffer(){
    try{
      offerStatus.textContent = "Добавляю…";
      offerStatus.className = "status";
      await api("/api/admin/offers", {
        method:"POST",
        body: JSON.stringify({
          amountRub: amountRub.value,
          method: method.value,
          rate: rate.value,
          payBank: payBank.value,
          payRequisite: payRequisite.value,
        })
      });

      amountRub.value = "";
      rate.value = "";
      payBank.value = "";
      payRequisite.value = "";

      await loadOffers();
      offerStatus.textContent = "Добавлено.";
      offerStatus.className = "status ok";
    } catch(e){
      offerStatus.textContent = "Ошибка: " + e.message;
      offerStatus.className = "status bad";
    }
  }

  async function setStatus(id, status){
    await api(`/api/admin/offers/${id}`, { method:"PATCH", body: JSON.stringify({ status }) });
    await loadOffers();
  }

  async function loadOffers(){
    try{
      offerStatus.textContent = "Загружаю заявки…";
      offerStatus.className = "status";
      const j = await api("/api/admin/offers", { method:"GET" });

      tbody.innerHTML = "";

      for (const o of (j.offers || [])){
        const st = String(o.status || "NEW").toUpperCase();

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="mono">${safe(o.id)}</span></td>
          <td>${fmtRub(o.amountRub)}</td>
          <td><span class="tag">${safe(o.method)}</span></td>
          <td><b>${Number(o.rate).toLocaleString("ru-RU")}</b></td>
          <td><span class="tag">${safe(statusRu(st))}</span></td>
          <td>${renderCheck(o)}</td>
          <td>${renderFiles(o)}</td>
          <td></td>
        `;

        const td = tr.querySelector("td:last-child");

        const freezeBtn = document.createElement("button");
        freezeBtn.className = "btn warn";
        freezeBtn.textContent = o.frozen ? "Разморозить" : "Заморозить";
        freezeBtn.onclick = async () => {
          await api(`/api/admin/offers/${o.id}`, { method:"PATCH", body: JSON.stringify({ frozen: !o.frozen }) });
          await loadOffers();
        };
        td.appendChild(freezeBtn);

        if (st === "ON_CHECK") {
          const okBtn = document.createElement("button");
          okBtn.className = "btn ok";
          okBtn.style.marginLeft = "8px";
          okBtn.textContent = "Успешно";
          okBtn.onclick = async () => setStatus(o.id, "SUCCESS");
          td.appendChild(okBtn);

          const failBtn = document.createElement("button");
          failBtn.className = "btn danger";
          failBtn.style.marginLeft = "8px";
          failBtn.textContent = "Неуспешно";
          failBtn.onclick = async () => setStatus(o.id, "FAILED");
          td.appendChild(failBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.className = "btn danger";
        delBtn.style.marginLeft = "8px";
        delBtn.textContent = "Удалить";
        delBtn.onclick = async () => {
          if (!confirm("Удалить заявку?")) return;
          await api(`/api/admin/offers/${o.id}`, { method:"DELETE" });
          await loadOffers();
        };
        td.appendChild(delBtn);

        tbody.appendChild(tr);
      }

      offerStatus.textContent = "Готово.";
      offerStatus.className = "status ok";
    } catch(e){
      offerStatus.textContent = "Ошибка: " + e.message;
      offerStatus.className = "status bad";
    }
  }

  document.getElementById("saveConfig").onclick = saveConfig;
  document.getElementById("addOffer").onclick = addOffer;
  document.getElementById("refresh").onclick = async () => { await loadConfig(); await loadOffers(); };

  loadConfig();
  loadOffers();
  setInterval(loadOffers, 5000);
</script>
</body>
</html>
