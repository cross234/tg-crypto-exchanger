<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2P · Купить</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a30;
      --border:#223255;
      --text:#e9f0ff;
      --muted:#9fb0d4;
      --buy:#2563eb;
      --row:#0c162a;
      --bad:#ffb4b4;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:820px; margin:0 auto; padding:18px; }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .title{ font-size:16px; font-weight:950; }
    .back{
      color:#cfe0ff;
      text-decoration:none;
      font-weight:800;
      border:1px solid rgba(255,255,255,.12);
      padding:8px 10px;
      border-radius:12px;
      background: rgba(255,255,255,.03);
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
    }

    .status{
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .status.bad{
      color:var(--bad);
      font-weight:900;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
    }
    thead{
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight:950;
    }
    th, td{
      padding:12px 14px;
      text-align:left;
    }
    thead th{
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    tbody tr{
      background: var(--row);
    }
    tbody tr + tr td{
      border-top:1px solid rgba(255,255,255,.06);
    }

    .method{
      display:inline-flex;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:#d6e2ff;
      font-weight:900;
      font-size:12px;
    }

    .buybtn{
      background: var(--buy);
      border:0;
      color:#fff;
      font-weight:950;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      width:100%;
      max-width:140px;
    }

    .empty{
      padding:18px;
      text-align:center;
      color:var(--muted);
      font-size:13px;
    }

    @media (max-width: 740px){
      thead{ display:none; }
      tbody tr{ display:block; }
      tbody td{
        display:flex;
        justify-content:space-between;
        gap:12px;
      }
      tbody td::before{
        content: attr(data-label);
        color: var(--muted);
        font-weight:900;
      }
      .buybtn{ max-width:none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">P2P · Купить USDT</div>
      <a class="back" href="./index.html">← Назад</a>
    </div>

    <div class="card">
      <div class="status" id="status">Загружаю заявки…</div>

      <table>
        <thead>
          <tr>
            <th>Сумма (RUB)</th>
            <th>Метод</th>
            <th>Курс (RUB/USDT)</th>
            <th style="width:160px;">Действие</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  const statusEl = document.getElementById("status");
  const rowsEl = document.getElementById("rows");

  function setStatus(text, bad=false){
    statusEl.textContent = text;
    statusEl.classList.toggle("bad", bad);
  }

  function fmtRub(n){
    return Number(n).toLocaleString("ru-RU") + " ₽";
  }
  function fmtRate(n){
    return Number(n).toLocaleString("ru-RU");
  }
  function methodLabel(m){
    return m === "SBP" ? "СБП" : "Карта";
  }

  function renderOffers(offers){
    rowsEl.innerHTML = "";

    if (!offers.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td colspan="4">
          <div class="empty">Нет активных заявок</div>
        </td>
      `;
      rowsEl.appendChild(tr);
      return;
    }

    for (const o of offers){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="Сумма"><b>${fmtRub(o.amountRub)}</b></td>
        <td data-label="Метод"><span class="method">${methodLabel(o.method)}</span></td>
        <td data-label="Курс"><b>${fmtRate(o.rate)}</b></td>
        <td data-label="Действие">
          <button class="buybtn" type="button">Купить</button>
        </td>
      `;

      tr.querySelector("button").onclick = () => {
        alert(
          `Покупка (демо)\n\nСумма: ${fmtRub(o.amountRub)}\nМетод: ${methodLabel(o.method)}\nКурс: ${fmtRate(o.rate)}`
        );
      };

      rowsEl.appendChild(tr);
    }
  }

  async function loadOffers(){
    try{
      setStatus("Загружаю заявки…");
      const res = await fetch(WORKER_BASE + "/api/public/buy_offers");
      const j = await res.json();
      if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));

      renderOffers(j.offers || []);
      setStatus("Обновлено");
    } catch(e){
      setStatus("Ошибка: " + e.message, true);
    }
  }

  loadOffers();
  setInterval(loadOffers, 10000);
</script>
</body>
</html>
