<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Crossflag Exchange · Оплата</title>

  <style>
    :root{
      --text:#e9f0ff;
      --muted:#9fb0d4;
      --shadow: 0 25px 70px rgba(0,0,0,.45);
      --radius:22px;

      --ok:#2ecc71;
      --bad:#ff5a5a;

      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% -260px, #1a2a55, #070b18);
      color:var(--text);
    }
    .wrap{
      max-width:980px;
      margin:18px auto;
      padding:
        calc(12px + env(safe-area-inset-top))
        16px
        calc(28px + env(safe-area-inset-bottom))
        16px;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; flex-wrap:wrap;
    }
    .title{ font-weight:1000; font-size:18px; }

    .btn{
      border:0; border-radius:16px; padding:12px 16px;
      background:linear-gradient(180deg, #2d5bff, #1f3fb3);
      color:#fff; font-weight:900; cursor:pointer;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .btnGhost{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 16px;
      padding: 12px 16px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 14px 40px rgba(0,0,0,.20);
      white-space:nowrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; padding:18px; }
    .cell{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
      min-width:0;
    }
    .label{ color:var(--muted); font-size:12px; margin-bottom:6px; }
    .value{ font-weight:1000; font-size:16px; overflow-wrap:anywhere; word-break:break-word; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cfe0ff; }

    .panel{ padding:18px; border-top:1px solid rgba(255,255,255,.06); }
    .panelBox{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(45,91,255,.18), transparent 60%),
        rgba(255,255,255,.03);
      padding:18px;
    }

    .status{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      font-weight:950;
      color:var(--muted);
    }
    .status.ok{ color:var(--ok); border-color: rgba(46,204,113,.35); background: rgba(46,204,113,.10); }
    .status.bad{ color:var(--bad); border-color: rgba(255,90,90,.35); background: rgba(255,90,90,.10); }

    .rowLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      margin-top:10px;
    }
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:6px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
    }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px; }

    @media(max-width:780px){
      .grid{ grid-template-columns:1fr; }
      .btn,.btnGhost{ width:100%; }
      .actions{ justify-content:stretch; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Crossflag Exchange · Оплата</div>
      <button class="btnGhost" id="backBtn" type="button">Назад</button>
    </div>

    <div class="card">
      <div class="grid">
        <div class="cell">
          <div class="label">Ордер</div>
          <div class="value mono" id="oid">—</div>
        </div>
        <div class="cell">
          <div class="label">Сумма к оплате (RUB)</div>
          <div class="value" id="amount">—</div>
        </div>
        <div class="cell">
          <div class="label">Курс (RUB/USDT)</div>
          <div class="value" id="rate">—</div>
        </div>
        <div class="cell">
          <div class="label">Получите (USDT)</div>
          <div class="value" id="usdt">—</div>
        </div>
      </div>

      <div class="panel">
        <div class="panelBox">
          <div class="rowLine">
            <div style="font-weight:1000;">Статус</div>
            <div class="pill" id="timer">—</div>
          </div>
          <div class="status" id="status">Загружаю реквизиты…</div>

          <div style="margin-top:14px; font-weight:1000;">Реквизиты для оплаты</div>

          <div class="rowLine">
            <div>
              <div class="label">Банк</div>
              <div class="value" id="bank">—</div>
            </div>
          </div>

          <div class="rowLine">
            <div style="min-width:0;">
              <div class="label">Реквизиты (СБП/карта)</div>
              <div class="value mono" id="req">—</div>
            </div>
            <button class="btnGhost" id="copyBtn" type="button">Копировать</button>
          </div>

          <div class="actions">
            <button class="btnGhost" id="cancelBtn" type="button">Отменить ордер</button>
            <button class="btn" id="paidBtn" type="button">Я оплатил</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  const p = new URLSearchParams(location.search);
  const id = (p.get("id") || "").trim();
  const amountRub = Number(p.get("amountRub"));
  const rate = Number(p.get("rate"));
  const method = (p.get("method") || "").trim();

  const oidEl = document.getElementById("oid");
  const amountEl = document.getElementById("amount");
  const rateEl = document.getElementById("rate");
  const usdtEl = document.getElementById("usdt");
  const bankEl = document.getElementById("bank");
  const reqEl = document.getElementById("req");
  const statusEl = document.getElementById("status");
  const timerEl = document.getElementById("timer");

  let reserveId = "";
  let expiresAt = 0;
  let timerHandle = null;
  let finished = false;

  const storageKey = "cf_reserve_" + id;

  function fmtRub(n){ return Number(n).toLocaleString("ru-RU") + " ₽"; }
  function fmtRate(n){ return Number(n).toLocaleString("ru-RU", { maximumFractionDigits: 2 }); }
  function fmtUsdt(n){ return Number(n).toLocaleString("ru-RU", { maximumFractionDigits: 6 }) + " USDT"; }

  function setStatus(text, kind){
    statusEl.textContent = text;
    statusEl.classList.remove("ok","bad");
    if (kind) statusEl.classList.add(kind);
  }

  function basicFill(){
    oidEl.textContent = id || "—";
    amountEl.textContent = Number.isFinite(amountRub) ? fmtRub(amountRub) : "—";
    rateEl.textContent = Number.isFinite(rate) ? fmtRate(rate) : "—";
    if (Number.isFinite(amountRub) && Number.isFinite(rate) && rate > 0){
      usdtEl.textContent = fmtUsdt(amountRub / rate);
    } else {
      usdtEl.textContent = "—";
    }
  }

  async function postJson(path, body){
    const res = await fetch(WORKER_BASE + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch { throw new Error("Worker вернул не JSON: " + text.slice(0, 200)); }
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  function saveReserveLocal(reserveId, expiresAt){
    localStorage.setItem(storageKey, JSON.stringify({ reserveId, expiresAt }));
  }
  function loadReserveLocal(){
    try{
      const raw = localStorage.getItem(storageKey);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  }
  function clearReserveLocal(){
    localStorage.removeItem(storageKey);
  }

  function goBackToBuyOrder(){
    window.location.href =
      "./buy-order.html?id=" + encodeURIComponent(id) +
      "&amountRub=" + encodeURIComponent(String(amountRub)) +
      "&rate=" + encodeURIComponent(String(rate)) +
      "&method=" + encodeURIComponent(method);
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function updateTimer(){
    if (!expiresAt){
      timerEl.textContent = "—";
      return;
    }
    const ms = expiresAt - Date.now();
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s%60;
    timerEl.textContent = `${pad2(m)}:${pad2(r)}`;
    if (ms <= 0 && !finished) autoCancelDueToTimeout();
  }

  async function autoCancelDueToTimeout(){
    finished = true;
    setStatus("Время вышло. Заявка отменена.", "bad");
    try{
      if (reserveId) await postJson("/api/public/cancel_reserve", { id, reserveId });
    }catch(e){}
    clearReserveLocal();
    setTimeout(()=> location.href="buy.html", 600);
  }

  async function loadOrReserve(){
    basicFill();
    if (!id){
      setStatus("Ошибка: нет id заявки.", "bad");
      return;
    }

    const cached = loadReserveLocal();
    if (cached?.reserveId){
      reserveId = String(cached.reserveId || "");
      expiresAt = Number(cached.expiresAt || 0);

      try{
        // keep-alive резерва (разрешено перезагружать страницу)
        const j = await postJson("/api/public/reserve_offer", { id, reserveId });
        reserveId = j.reserveId;
        expiresAt = j.expiresAt;

        bankEl.textContent = j.offer.payBank || "—";
        reqEl.textContent = j.offer.payRequisite || "—";

        saveReserveLocal(reserveId, expiresAt);
        setStatus("Реквизиты выданы. Оплати и нажми “Я оплатил”.", "ok");
      }catch(e){
        setStatus("Ошибка: " + (e.message || e), "bad");
      }
      return;
    }

    try{
      setStatus("Резервирую заявку и загружаю реквизиты…");
      const j = await postJson("/api/public/reserve_offer", { id });

      reserveId = j.reserveId;
      expiresAt = j.expiresAt;

      bankEl.textContent = j.offer.payBank || "—";
      reqEl.textContent = j.offer.payRequisite || "—";

      saveReserveLocal(reserveId, expiresAt);
      setStatus("Заявка зарезервирована на 15 минут. Оплати и нажми “Я оплатил”.", "ok");
    }catch(e){
      setStatus("Ошибка: " + (e.message || e), "bad");
    }
  }

  document.getElementById("copyBtn").onclick = async () => {
    const v = reqEl.textContent || "";
    try{
      await navigator.clipboard.writeText(v);
      alert("Скопировано");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = v;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("Скопировано");
    }
  };

  document.getElementById("cancelBtn").onclick = async () => {
    try{
      if (reserveId) await postJson("/api/public/cancel_reserve", { id, reserveId });
    }catch(e){}
    clearReserveLocal();
    location.href = "buy.html";
  };

  document.getElementById("paidBtn").onclick = async () => {
    if (!reserveId){
      setStatus("Нет reserveId. Обнови страницу.", "bad");
      return;
    }
    try{
      await postJson("/api/public/mark_paid", { id, reserveId });
      // переход на страницу подтверждения оплаты
      const qs = new URLSearchParams({
        id: String(id),
        reserveId: String(reserveId),
        amountRub: String(amountRub),
        rate: String(rate),
        method: String(method),
      });
      location.href = "./buy-paid.html?" + qs.toString();
    }catch(e){
      setStatus("Ошибка: " + (e.message || e), "bad");
    }
  };

  document.getElementById("backBtn").onclick = goBackToBuyOrder;

  loadOrReserve();
  timerHandle = setInterval(updateTimer, 300);
</script>
</body>
</html>
