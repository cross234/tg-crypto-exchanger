<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  // Эти id должны уже быть в твоём index (как раньше):
  // buyRateEl  -> элемент, где показывается "Купить"
  // sellRateEl -> элемент, где показывается "Продать"
  // updatedEl  -> элемент "Обновлено: ..."
  const buyRateEl  = document.getElementById("buyRate");
  const sellRateEl = document.getElementById("sellRate");
  const updatedEl  = document.getElementById("updated");

  // Кнопки перехода (как было)
  const goBuyBtn  = document.getElementById("goBuy");
  const goSellBtn = document.getElementById("goSell");
  if (goBuyBtn)  goBuyBtn.onclick  = () => (window.location.href = "./buy.html");
  if (goSellBtn) goSellBtn.onclick = () => (window.location.href = "./sell.html");

  function fmtRate(n){
    const num = Number(n);
    if (!Number.isFinite(num)) return "—";
    return num.toLocaleString("ru-RU", { maximumFractionDigits: 2 });
  }

  function bestBuyRate(offers){
    // Для покупателя выгоднее МЕНЬШЕ
    let best = Infinity;
    for (const o of (offers || [])){
      const r = Number(o.rate);
      if (Number.isFinite(r) && r > 0) best = Math.min(best, r);
    }
    return best === Infinity ? null : best;
  }

  function bestSellRate(offers){
    // Для продавца выгоднее БОЛЬШЕ
    let best = -Infinity;
    for (const o of (offers || [])){
      const r = Number(o.rate);
      if (Number.isFinite(r) && r > 0) best = Math.max(best, r);
    }
    return best === -Infinity ? null : best;
  }

  async function loadRatesFromOrders(){
    try{
      const [bRes, sRes] = await Promise.all([
        fetch(WORKER_BASE + "/api/public/buy_offers", { cache: "no-store" }),
        fetch(WORKER_BASE + "/api/public/sell_offers", { cache: "no-store" }),
      ]);

      const b = await bRes.json();
      const s = await sRes.json();

      const buyBest  = (b && b.ok) ? bestBuyRate(b.offers || []) : null;
      const sellBest = (s && s.ok) ? bestSellRate(s.offers || []) : null;

      if (buyRateEl)  buyRateEl.textContent  = (buyBest  == null) ? "—" : fmtRate(buyBest);
      if (sellRateEl) sellRateEl.textContent = (sellBest == null) ? "—" : fmtRate(sellBest);

      if (updatedEl){
        const d = new Date();
        updatedEl.textContent = "Обновлено: " + d.toLocaleString("ru-RU");
      }
    }catch(e){
      // Не ломаем интерфейс — просто показываем, что обновление не получилось
      if (updatedEl){
        const d = new Date();
        updatedEl.textContent = "Обновлено: " + d.toLocaleString("ru-RU");
      }
    }
  }

  loadRatesFromOrders();
  setInterval(loadRatesFromOrders, 10000);
</script>
