<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Crossflag Exchange · HTX</title>

  <style>
    :root{
      --text:#e9f0ff;
      --muted:#9fb0d4;
      --card: rgba(15, 26, 48, 0.52);
      --border: rgba(255,255,255,.12);
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --btn:#2d5bff;
      --btn2:#1f3fb3;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background:#071022;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }
    .overlay{
      position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(900px 600px at 50% 20%, rgba(60,120,255,.18), rgba(0,0,0,0) 60%),
        radial-gradient(900px 600px at 80% 80%, rgba(245,158,11,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(7,16,34,.82), rgba(7,16,34,.92));
      pointer-events:none;
    }
    .page{
      min-height:100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: calc(16px + env(safe-area-inset-top)) 16px calc(22px + env(safe-area-inset-bottom)) 16px;
      box-sizing:border-box;
    }
    .wrap{ width:100%; max-width:720px; }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .top{ display:flex; justify-content:space-between; gap:10px; margin-bottom:12px; }
    .title{ font-weight:1000; font-size:16px; }
    .sub{ font-size:12px; color:var(--muted); margin-top:4px; }

    .panel{
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      margin-top:12px;
      position:relative;
      overflow:hidden;
    }
    .shine{
      position:absolute; inset:-60px;
      background: radial-gradient(420px 130px at 35% 35%, rgba(45,91,255,.18), transparent 60%),
                  radial-gradient(420px 130px at 70% 70%, rgba(245,158,11,.10), transparent 60%);
      filter: blur(18px);
      pointer-events:none;
    }

    .loaderRow{
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-bottom:12px;
      position:relative;
      z-index:1;
    }

    .spinner{
      width:44px; height:44px; border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
      flex:0 0 auto;
      margin-top:2px;
    }

    /* ✅ Новая анимация: спокойные "прыгающие" точки */
    .dots{display:flex;gap:6px;align-items:center;justify-content:center;}
    .dots span{
      width:7px;height:7px;border-radius:999px;
      background:rgba(255,255,255,.70);
      display:block;
      transform:translateY(0);
      opacity:.55;
      animation:dotsBounce 1.1s infinite ease-in-out;
    }
    .dots span:nth-child(2){animation-delay:.15s;opacity:.65;}
    .dots span:nth-child(3){animation-delay:.30s;opacity:.75;}
    @keyframes dotsBounce{
      0%,100%{transform:translateY(0);opacity:.45;}
      50%{transform:translateY(-6px);opacity:1;}
    }

    .h1{ margin:0; font-weight:1000; font-size:15px; }
    .p{ margin:6px 0 0; color:var(--muted); font-size:12px; line-height:1.35; }

    .infoGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin: 10px 0 12px;
      position:relative;
      z-index:1;
    }
    @media(max-width:640px){ .infoGrid{ grid-template-columns:1fr; } }

    .box{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .label{ font-weight:900; font-size:12px; color:var(--muted); margin-bottom:6px; }
    .value{ font-weight:1000; font-size:14px; word-break:break-word; }

    .status{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      font-weight:900;
      font-size:13px;
      position:relative;
      z-index:1;
    }
    .status.ok{ background: rgba(34,197,94,.10); }
    .status.bad{ background: rgba(239,68,68,.10); }
    .status.warn{ background: rgba(245,158,11,.10); }

    .actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }
    .btn{
      border:0;
      border-radius:14px;
      padding:12px 16px;
      font-weight:1000;
      cursor:pointer;
    }
    .btn.cancel{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color:#fff;
      min-width:220px;
      opacity:.65;
      cursor:not-allowed;
    }
    .btn.primary.ready{
      opacity:1;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="overlay"></div>

<div class="page">
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="title">Crossflag Exchange · HTX</div>
          <div class="sub" id="subtitle">Создаём сделку и готовим ссылку…</div>
        </div>
      </div>

      <div class="panel">
        <div class="shine"></div>

        <div class="loaderRow">
          <div class="spinner"><span class="dots"><span></span><span></span><span></span></span></div>
          <div>
            <p class="h1">Создаём вашу сделку</p>
            <p class="p">Обычно это занимает немного времени. Как только менеджер добавит ссылку — кнопка загорится.</p>
          </div>
        </div>

        <div class="infoGrid">
          <div class="box">
            <div class="label">ID заявки</div>
            <div class="value" id="oid">—</div>
          </div>
          <div class="box">
            <div class="label">Reserve ID</div>
            <div class="value" id="rid">—</div>
          </div>
        </div>

        <div class="status warn" id="statusBox">Ожидаем ссылку на сделку…</div>

        <div class="actions">
          <button class="btn cancel" id="cancelBtn" type="button">Отменить</button>
          <button class="btn cancel" id="copyBtn" type="button">Скопировать ссылку</button>
          <button class="btn primary" id="goBtn" type="button">Перейти к сделке</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) { try { tg.expand(); tg.ready(); } catch(e){} }

  const p = new URLSearchParams(location.search);
  const API = (p.get("api") || "").replace(/\/+$/, "");
  const id = (p.get("id") || "").trim();
  const reserveId = (p.get("reserveId") || p.get("reservedId") || "").trim();
  const type = String(p.get("type") || "BUY").toUpperCase(); // BUY | SELL

  const subtitleEl = document.getElementById("subtitle");
  const oidEl = document.getElementById("oid");
  const ridEl = document.getElementById("rid");
  const statusBox = document.getElementById("statusBox");
  const goBtn = document.getElementById("goBtn");
  const copyBtn = document.getElementById("copyBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  oidEl.textContent = id || "—";
  ridEl.textContent = reserveId || "—";

  let dealUrl = "";

  function openExternal(url){
    if (!url) return;
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg && typeof tg.openLink === "function"){
      try { tg.openLink(url); return; } catch(e) {}
    }
    try { window.open(url, "_blank", "noopener"); }
    catch(e){ window.location.href = url; }
  }

  function setStatus(text, kind){
    statusBox.textContent = text;
    statusBox.className = "status " + (kind || "warn");
  }

  function isUrl(s){
    try { new URL(s); return true; } catch { return false; }
  }

  function enableGo(url){
    dealUrl = url;
    goBtn.classList.add("ready");
    goBtn.disabled = false;
    goBtn.style.cursor = "pointer";
    if (copyBtn){ copyBtn.disabled = false; copyBtn.style.cursor = "pointer"; }
    if (subtitleEl) subtitleEl.textContent = "Сделка успешно создана ✅";
    setStatus("Ссылка готова — можно перейти или скопировать. ✅", "ok");
  }

  goBtn.disabled = true;
  if (copyBtn) copyBtn.disabled = true;

  if (copyBtn){
    copyBtn.addEventListener("click", async () => {
      if (!dealUrl) return;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(dealUrl);
        } else {
          const ta = document.createElement("textarea");
          ta.value = dealUrl;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
        setStatus("Ссылка скопирована ✅", "ok");
      } catch (e) {
        setStatus("Не удалось скопировать ссылку. ✅", "warn");
      }
    });
  }

  goBtn.addEventListener("click", () => {
    if (!dealUrl) return;
    openExternal(dealUrl);
  });

  cancelBtn.addEventListener("click", async () => {
    try{
      if (API && id && reserveId){
        const cancelPath = (type === "SELL") ? "/api/public/cancel_sell_reserve" : "/api/public/cancel_reserve";
        await fetch(API + cancelPath, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ id, reserveId })
        });
      }
    }catch(e){}
    const back = (type === "SELL") ? "./sell.html" : "./buy.html";
    window.location.href = back + (API ? ("?api=" + encodeURIComponent(API)) : "");
  });

  async function poll(){
    if (!API || !id || !reserveId){
      setStatus("Ошибка: не хватает параметров (api/id/reserveId)", "bad");
      return;
    }

    try{
      const url = API + "/api/public/order_info?id=" + encodeURIComponent(id) +
                  "&reserveId=" + encodeURIComponent(reserveId) +
                  "&type=" + encodeURIComponent(type);

      const res = await fetch(url, { method:"GET" });
      const j = await res.json();

      if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));

      const st = String(j.status || "").toUpperCase();
      const tx = (j.txHash || "").trim(); // используем как "deal link"

      if (isUrl(tx)) {
        enableGo(tx);
        return;
      }

      setStatus("Ожидаем ссылку на сделку…", "warn");
    } catch(e){
      setStatus("Ошибка проверки статуса: " + (e.message || e), "bad");
    }

    setTimeout(poll, 2500);
  }

  poll();
</script>
</body>
</html>
