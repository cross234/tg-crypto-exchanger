<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crossflag · Оплата</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --border:#223255; --text:#e9f0ff;
      --muted:#9fb0d4; --ok:#9dffb8; --bad:#ffb4b4; --btn:#2563eb; --danger:#ef4444;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:18px; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .title{ font-size:16px; font-weight:950; }
    .back{
      color:#cfe0ff; text-decoration:none; font-weight:800;
      border:1px solid rgba(255,255,255,.12); padding:8px 10px; border-radius:12px;
      background: rgba(255,255,255,.03);
    }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; box-shadow:0 18px 50px rgba(0,0,0,.35); }
    .section{ padding:14px; }
    .section + .section{ border-top:1px solid rgba(255,255,255,.08); }
    .kv{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:640px){ .kv{ grid-template-columns:1fr; } }
    .item{ background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:12px; }
    .label{ color:var(--muted); font-size:12px; font-weight:900; margin-bottom:6px; }
    .value{ font-size:15px; font-weight:950; word-break:break-word; }
    .rowLine{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03); color:#cfe0ff; font-weight:950; font-size:12px; }
    .pill b{ color:#fff; }
    .status{ margin-top:10px; font-size:12px; color:var(--muted); white-space:pre-wrap; }
    .status.ok{ color:var(--ok); font-weight:900; }
    .status.bad{ color:var(--bad); font-weight:900; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px; }
    .btn{ border:0; border-radius:12px; padding:12px 14px; cursor:pointer; color:#fff; font-weight:950; background: var(--btn); min-width:160px; }
    .btn.danger{ background: var(--danger); min-width:auto; }
    .btn.small{ padding:8px 10px; min-width:auto; font-size:12px; border-radius:10px; background: rgba(255,255,255,.10); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:#cfe0ff; }
    .reqLine{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
    .reqValue{ flex:1; word-break:break-word; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Crossflag Exchange · Оплата</div>
      <a class="back" href="./buy-order.html">← Назад</a>
    </div>

    <div class="card">
      <div class="section">
        <div class="kv">
          <div class="item">
            <div class="label">Ордер</div>
            <div class="value mono" id="oid">—</div>
          </div>
          <div class="item">
            <div class="label">Сумма к оплате (RUB)</div>
            <div class="value" id="amount">—</div>
          </div>
          <div class="item">
            <div class="label">Курс (RUB/USDT)</div>
            <div class="value" id="rate">—</div>
          </div>
          <div class="item">
            <div class="label">Получите (USDT)</div>
            <div class="value" id="usdt">—</div>
          </div>
        </div>

        <div class="rowLine">
          <span class="pill">Статус: <b id="st">Загрузка…</b></span>
          <span class="pill">Осталось: <b id="timer">15:00</b></span>
        </div>

        <div class="status" id="status">—</div>
      </div>

      <div class="section">
        <div style="font-weight:950; margin-bottom:10px;">Реквизиты для оплаты</div>

        <div class="kv">
          <div class="item">
            <div class="label">Банк</div>
            <div class="value" id="bank">—</div>
          </div>

          <div class="item">
            <div class="label">Реквизиты (СБП/карта)</div>
            <div class="reqLine">
              <div class="value reqValue mono" id="req">—</div>
              <button class="btn small" id="copyReqBtn" type="button">Копировать</button>
            </div>
          </div>
        </div>

        <div class="status" style="margin-top:10px;">
          Переведи точную сумму и нажми “Я оплатил”.
        </div>

        <div class="btnRow">
          <button class="btn danger" id="cancelBtn" type="button">Отменить ордер</button>
          <button class="btn" id="paidBtn" type="button">Я оплатил</button>
        </div>

        <div class="status" id="paidStatus">—</div>
      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  const p = new URLSearchParams(location.search);
  const id = p.get("id") || "";
  const amountRub = Number(p.get("amountRub"));
  const rate = Number(p.get("rate"));

  const oidEl = document.getElementById("oid");
  const amountEl = document.getElementById("amount");
  const rateEl = document.getElementById("rate");
  const usdtEl = document.getElementById("usdt");

  const bankEl = document.getElementById("bank");
  const reqEl = document.getElementById("req");

  const stEl = document.getElementById("st");
  const timerEl = document.getElementById("timer");

  const statusEl = document.getElementById("status");
  const paidStatusEl = document.getElementById("paidStatus");

  let reserveId = "";
  let reservedUntil = 0;
  let timerHandle = null;
  let finished = false;

  const storageKey = "cf_reserve_" + id;

  function fmtRub(n){ return Number(n).toLocaleString("ru-RU") + " ₽"; }
  function fmtRate(n){ return Number(n).toLocaleString("ru-RU"); }
  function fmtUsdt(n){ return Number(n).toLocaleString("ru-RU", { maximumFractionDigits: 6 }) + " USDT"; }

  function setStatus(text, kind){
    statusEl.textContent = text;
    statusEl.classList.remove("ok","bad");
    if (kind) statusEl.classList.add(kind);
  }
  function setPaidStatus(text, kind){
    paidStatusEl.textContent = text;
    paidStatusEl.classList.remove("ok","bad");
    if (kind) paidStatusEl.classList.add(kind);
  }
  function setState(text){ stEl.textContent = text; }

  function basicFill(){
    oidEl.textContent = id || "—";
    amountEl.textContent = Number.isFinite(amountRub) ? fmtRub(amountRub) : "—";
    rateEl.textContent = Number.isFinite(rate) ? fmtRate(rate) : "—";
    usdtEl.textContent = (Number.isFinite(amountRub) && Number.isFinite(rate) && rate>0) ? fmtUsdt(amountRub / rate) : "—";
  }

  function pad2(n){ return String(n).padStart(2, "0"); }
  function updateTimer(){
    if (!reservedUntil) return;
    const ms = reservedUntil - Date.now();
    const clamped = Math.max(0, ms);
    const totalSec = Math.floor(clamped / 1000);
    const m = Math.floor(totalSec / 60);
    const s = totalSec % 60;
    timerEl.textContent = `${pad2(m)}:${pad2(s)}`;

    if (ms <= 0 && !finished){
      autoCancelDueToTimeout();
    }
  }

  async function postJson(path, body){
    const res = await fetch(WORKER_BASE + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch { throw new Error("Worker вернул не JSON: " + text.slice(0, 200)); }
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  function saveReserveLocal(reserveId, reservedUntil){
    localStorage.setItem(storageKey, JSON.stringify({ reserveId, reservedUntil }));
  }
  function loadReserveLocal(){
    try{
      const raw = localStorage.getItem(storageKey);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch { return null; }
  }
  function clearReserveLocal(){
    localStorage.removeItem(storageKey);
  }

  async function loadOrReserve(){
    basicFill();

    if (!id){
      setState("Ошибка");
      setStatus("Ошибка: нет id заявки. Вернись назад и выбери заявку заново.", "bad");
      return;
    }

    // 1) если уже есть reserveId в браузере — пробуем открыть СВОЙ резерв (F5-friendly)
    const cached = loadReserveLocal();
    if (cached?.reserveId){
      try{
        setState("Открываю резерв…");
        setStatus("Восстанавливаю твою сделку после обновления страницы…");

        const j = await postJson("/api/public/get_reserved_buy_offer", {
          id,
          reserveId: cached.reserveId
        });

        reserveId = j.reserve.reserveId;
        reservedUntil = j.reserve.reservedUntil;

        bankEl.textContent = j.offer.payBank || "—";
        reqEl.textContent = j.offer.payRequisite || "—";

        saveReserveLocal(reserveId, reservedUntil);

        setState("Ожидание оплаты");
        setStatus("Сделка восстановлена. Продолжай оплату и нажми “Я оплатил”.", "ok");

        updateTimer();
        timerHandle = setInterval(updateTimer, 1000);
        return;
      } catch(e){
        // если резерв уже невалиден/истёк — очистим и пойдём на новый reserve
        clearReserveLocal();
      }
    }

    // 2) иначе — резервируем заново
    try{
      setState("Резервирую…");
      setStatus("Загружаю реквизиты и резервирую заявку…");

      const j = await postJson("/api/public/reserve_buy_offer", { id });

      reserveId = j.reserve.reserveId;
      reservedUntil = j.reserve.reservedUntil;

      bankEl.textContent = j.offer.payBank || "—";
      reqEl.textContent = j.offer.payRequisite || "—";

      saveReserveLocal(reserveId, reservedUntil);

      if (!j.offer.payBank || !j.offer.payRequisite){
        setState("Резерв");
        setStatus("⚠️ Реквизиты не заполнены в админке для этой заявки.", "bad");
      } else {
        setState("Ожидание оплаты");
        setStatus("Заявка зарезервирована на 15 минут. Оплати и нажми “Я оплатил”.", "ok");
      }

      updateTimer();
      timerHandle = setInterval(updateTimer, 1000);
    } catch(e){
      setState("Ошибка");
      setStatus("Ошибка: " + e.message, "bad");
    }
  }

  async function autoCancelDueToTimeout(){
    if (finished) return;
    finished = true;
    if (timerHandle) clearInterval(timerHandle);

    setState("Отменено");
    setStatus("Время оплаты истекло. Ордер отменён, заявка разморожена.", "bad");

    try{
      if (reserveId){
        await postJson("/api/public/cancel_buy_offer", { id, reserveId });
      }
    } catch {}
    clearReserveLocal();
    setPaidStatus("—");
  }

  document.getElementById("paidBtn").onclick = async () => {
    if (finished) return;
    if (!reserveId){
      setPaidStatus("Нет резерва. Обнови страницу.", "bad");
      return;
    }
    try{
      await postJson("/api/public/confirm_buy_offer_paid", { id, reserveId });
      finished = true;
      if (timerHandle) clearInterval(timerHandle);

      setState("Оплачено");
      setStatus("Отлично. Мы получили отметку “Оплачено”. Далее будет проверка оплаты.", "ok");
      setPaidStatus("Ожидайте подтверждения оплаты.", "ok");
      // оставляем reserve в localStorage (не критично), но можно очистить:
      // clearReserveLocal();
    } catch(e){
      setPaidStatus("Ошибка: " + e.message, "bad");
    }
  };

  document.getElementById("cancelBtn").onclick = async () => {
    if (finished) return;
    if (!reserveId){
      setPaidStatus("Нет резерва. Обнови страницу.", "bad");
      return;
    }
    try{
      await postJson("/api/public/cancel_buy_offer", { id, reserveId });
      finished = true;
      if (timerHandle) clearInterval(timerHandle);

      setState("Отменено");
      setStatus("Ордер отменён, заявка разморожена.", "bad");
      clearReserveLocal();
      setPaidStatus("—");
    } catch(e){
      setPaidStatus("Ошибка: " + e.message, "bad");
    }
  };

  document.getElementById("copyReqBtn").onclick = async () => {
    const txt = reqEl.textContent || "";
    if (!txt || txt === "—"){
      setPaidStatus("Нечего копировать.", "bad");
      return;
    }
    try{
      await navigator.clipboard.writeText(txt);
      setPaidStatus("Реквизиты скопированы ✅", "ok");
    } catch {
      setPaidStatus("Не удалось скопировать. Скопируй вручную.", "bad");
    }
  };

  loadOrReserve();
</script>
</body>
</html>
