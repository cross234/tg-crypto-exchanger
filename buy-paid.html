<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>P2P · Подтверждение оплаты</title>

  <style>
    :root{
      --text:#e9f0ff;
      --muted:#9fb0d4;

      --card: rgba(15, 26, 48, 0.52);
      --border: rgba(255,255,255,.12);

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --btn:#2d5bff;
      --btn2:#1f3fb3;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 20px;

      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    *,*::before,*::after{ box-sizing:border-box; }

    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:#071022;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    .overlay{
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(1100px 700px at 50% -220px, rgba(45,91,255,.22), rgba(0,0,0,0) 65%),
        radial-gradient(900px 600px at 85% 85%, rgba(245,158,11,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(7,16,34,.84), rgba(7,16,34,.94));
      pointer-events:none;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding: calc(18px + env(safe-area-inset-top)) 16px calc(22px + env(safe-area-inset-bottom)) 16px;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    .title{
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .liveDot{
      width:10px; height:10px;
      border-radius:999px;
      background: rgba(34,197,94,.95);
      box-shadow: 0 0 0 0 rgba(34,197,94,.35);
      animation: dotPulse 1.25s ease-in-out infinite;
      flex: 0 0 auto;
    }
    @keyframes dotPulse{
      0%{ box-shadow: 0 0 0 0 rgba(34,197,94,.35); transform: scale(1); }
      60%{ box-shadow: 0 0 0 12px rgba(34,197,94,0); transform: scale(1.05); }
      100%{ box-shadow: 0 0 0 0 rgba(34,197,94,0); transform: scale(1); }
    }

    .card{
      position:relative;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
      margin-bottom:14px;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-60px;
      background:
        radial-gradient(520px 180px at 35% 20%, rgba(45,91,255,.18), rgba(0,0,0,0) 60%),
        radial-gradient(520px 180px at 75% 90%, rgba(34,197,94,.10), rgba(0,0,0,0) 60%);
      filter: blur(18px);
      pointer-events:none;
      z-index:0;
    }
    .card > *{ position:relative; z-index:1; }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media(max-width:900px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media(max-width:520px){
      .grid{ grid-template-columns: 1fr; }
    }

    .cell{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
    }
    .label{ color:var(--muted); font-size:12px; font-weight:950; margin-bottom:6px; }
    .value{ font-weight:1000; font-size:16px; word-break:break-word; overflow-wrap:anywhere; }

    .hint{
      color: rgba(233,240,255,.78);
      font-size:12px;
      font-weight:850;
      line-height:1.45;
    }

    label{
      display:block;
      margin-bottom:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:950;
    }

    select, input[type="text"], input[type="file"]{
      width:100%;
      max-width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-weight:900;
      font-size:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .block{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:none;
    }
    .block.show{ display:block; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      word-break:break-all;
    }

    .btnRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .btn{
      border:0;
      border-radius:14px;
      padding:12px 18px;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.30);
      position:relative;
      min-width: 190px;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:disabled{ opacity:.7; cursor:not-allowed; box-shadow:none; }

    .btnGhost{
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px 18px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      box-shadow:none;
      min-width: 190px;
    }
    .btnGhost:hover{ background: rgba(255,255,255,.09); }

    @keyframes spin{ to{ transform:rotate(360deg); } }
    .loading{
      pointer-events:none;
      opacity:.88;
    }
    .loading::after{
      content:"";
      position:absolute;
      top:50%;
      right:12px;
      width:16px;
      height:16px;
      margin-top:-8px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      animation: spin .9s linear infinite;
    }

    .status{
      margin-top:12px;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      font-weight:950;
      font-size:13px;
      white-space:pre-line;
      display:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .status.show{ display:block; }
    .status.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .status.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .status.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <div class="wrap">
    <div class="topRow">
      <div class="title">
        <span class="liveDot"></span>
        Crossflag Exchange · Подтверждение оплаты
      </div>
      <button class="btn" id="backBtn" type="button">Назад</button>
    </div>

    <div class="card">
      <div class="grid">
        <div class="cell">
          <div class="label">Ордер</div>
          <div class="value" id="oid">—</div>
        </div>
        <div class="cell">
          <div class="label">Сумма (RUB)</div>
          <div class="value" id="amount">—</div>
        </div>
        <div class="cell">
          <div class="label">Курс (RUB/USDT)</div>
          <div class="value" id="rate">—</div>
        </div>
        <div class="cell">
          <div class="label">Получите (USDT)</div>
          <div class="value" id="usdt">—</div>
        </div>
      </div>

      <div class="block show" style="margin-top:12px;">
        <div class="hint">
          Выберите банк, с которого была произведена оплата, и загрузите подтверждение по инструкции ниже.
        </div>

        <div style="margin-top:10px;">
          <label>Банк отправителя</label>
          <select id="bankSelect"></select>
        </div>

        <!-- T-bank / Sovcom: отправка на почту -->
        <div class="block" id="blockEmail">
          <div class="hint">
            Для <b>Т-Банка</b> и <b>Совкомбанка</b> отправь <b>чек</b> на почту:
            <div class="mono" style="margin-top:6px;">kireeshka73@gmail.com</div>
          </div>
          <div class="btnRow">
            <button class="btn" id="btnEmailSent" type="button">Я отправил чек на почту</button>
          </div>
        </div>

        <!-- Alfa: PDF + link -->
        <div class="block" id="blockAlfa">
          <div class="hint">
            <b>Альфа-Банк:</b> нужен <b>PDF чек</b> + <b>ссылка “разделение платежа”</b>.
          </div>
          <div style="margin-top:10px;">
            <label>Ссылка “разделение платежа”</label>
            <input id="alphaLink" type="text" placeholder="вставь ссылку разделения платежа" />
          </div>
          <div style="margin-top:10px;">
            <label>PDF чек</label>
            <input id="alfaPdf" type="file" accept="application/pdf" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendAlfa" type="button">Отправить на проверку</button>
          </div>
        </div>

        <!-- Sber: PDF чек + PDF выписка -->
        <div class="block" id="blockSber">
          <div class="hint">
            <b>Сбербанк:</b> нужны <b>PDF чек</b> и <b>PDF выписка</b>.
          </div>
          <div style="margin-top:10px;">
            <label>PDF чек</label>
            <input id="sberPdf1" type="file" accept="application/pdf" />
          </div>
          <div style="margin-top:10px;">
            <label>PDF выписка</label>
            <input id="sberPdf2" type="file" accept="application/pdf" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendSber" type="button">Отправить на проверку</button>
          </div>
        </div>

        <!-- Other: ONLY video -->
        <div class="block" id="blockOther">
          <div class="hint">
            <b>Другие банки:</b> нужно <b>видео</b> (телефон с банком снимают с другого телефона), где человек:
            <br>1) открывает AppStore / Google Play / RuStore
            <br>2) переходит в приложение банка через магазин
            <br>3) показывает в истории платежей нужный платеж
            <br>4) открывает и разворачивает чек
          </div>
          <div style="margin-top:10px;">
            <label>Видео</label>
            <input id="otherVideo" type="file" accept="video/*" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendOther" type="button">Отправить на проверку</button>
          </div>
        </div>

        <div class="status" id="status"></div>

        <div class="btnRow" style="margin-top:14px;">
          <button class="btnGhost" id="cancelBtn" type="button">Отменить заявку</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  const p = new URLSearchParams(location.search);
  const id = (p.get("id") || "").trim();
  const reserveId =
    (p.get("reserveId") || "").trim() ||
    (p.get("reservedId") || "").trim() ||
    (p.get("reserveid") || "").trim() ||
    (p.get("rid") || "").trim();

  const amountRub = Number(p.get("amountRub"));
  const rate = Number(p.get("rate"));
  const method = String(p.get("method") || "");

  const oidEl = document.getElementById("oid");
  const amountEl = document.getElementById("amount");
  const rateEl = document.getElementById("rate");
  const usdtEl = document.getElementById("usdt");
  const statusEl = document.getElementById("status");
  const bankSelect = document.getElementById("bankSelect");

  const blockEmail = document.getElementById("blockEmail");
  const blockAlfa  = document.getElementById("blockAlfa");
  const blockSber  = document.getElementById("blockSber");
  const blockOther = document.getElementById("blockOther");

  function fmtRub(n){ return Number(n).toLocaleString("ru-RU") + " ₽"; }
  function fmtRate(n){ return Number(n).toLocaleString("ru-RU"); }
  function fmtUsdt(n){ return Number(n).toLocaleString("ru-RU", { maximumFractionDigits: 6 }) + " USDT"; }

  function setStatus(text, kind){
    statusEl.textContent = text;
    statusEl.className = "status show " + (kind || "warn");
  }

  function setLoading(btn, on){
    if (!btn) return;
    if (on){
      btn.classList.add("loading");
      btn.dataset._txt = btn.textContent;
      btn.textContent = "Отправка…";
      btn.disabled = true;
    } else {
      btn.classList.remove("loading");
      btn.textContent = btn.dataset._txt || btn.textContent;
      btn.disabled = false;
    }
  }

  function hideAll(){
    blockEmail.classList.remove("show");
    blockAlfa.classList.remove("show");
    blockSber.classList.remove("show");
    blockOther.classList.remove("show");
  }

  function normalizeBankName(s){
    return (s || "")
      .toLowerCase()
      .replace(/ё/g, "е")
      .replace(/[\u2013\u2014]/g, "-")
      .replace(/\s+/g, " ")
      .trim();
  }

  // ====== BANK RULES (как ты написал) ======
  // EMAIL: Т-банк + Совкомбанк
  // ALFA: Альфа
  // SBER: Сбербанк
  // OTHER: все остальные
  function bankMode(){
    const n = normalizeBankName(bankSelect.value);

    // Т-Банк / T-Bank / Тинькофф (на всякий случай)
    const isTbank =
      n.includes("т-банк") || n.includes("т банк") || n.includes("t-bank") || n.includes("t bank") ||
      n.includes("тинькофф");

    const isSovcom =
      n.includes("совком") || n.includes("sovcom");

    if (isTbank || isSovcom) return "EMAIL";

    if (n.includes("альфа") || n.includes("alfa") || n.includes("alpha")) return "ALFA";

    if (n.includes("сбер") || n.includes("sber")) return "SBER";

    return "OTHER";
  }

  function onBankChange(){
    hideAll();
    const mode = bankMode();
    if (mode === "EMAIL") blockEmail.classList.add("show");
    else if (mode === "ALFA") blockAlfa.classList.add("show");
    else if (mode === "SBER") blockSber.classList.add("show");
    else blockOther.classList.add("show");
    setStatus("Выберите подтверждение и отправьте на проверку.", "warn");
  }

  function initHeader(){
    oidEl.textContent = id || "—";
    amountEl.textContent = Number.isFinite(amountRub) ? fmtRub(amountRub) : "—";
    rateEl.textContent = (Number.isFinite(rate) && rate>0) ? fmtRate(rate) : "—";
    usdtEl.textContent = (Number.isFinite(amountRub) && Number.isFinite(rate) && rate>0) ? fmtUsdt(amountRub / rate) : "—";
  }

  function goBack(){
    const qs = new URLSearchParams({
      id, amountRub: String(amountRub), rate: String(rate), method: String(method), reserveId
    });
    window.location.href = "./crossflag-buy-order.html?" + qs.toString();
  }

  document.getElementById("backBtn").onclick = (e) => { e.preventDefault(); goBack(); };

  async function markPaid(){
    const res = await fetch(WORKER_BASE + "/api/public/mark_paid", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ id, reserveId })
    });
    const j = await res.json().catch(()=> ({}));
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  // submit_proof ожидает multipart/form-data (по воркеру)
  async function submitMultipart({ bankFrom, proofType, alphaLink, pdf1, pdf2, video }){
    const fd = new FormData();
    fd.set("id", id);
    fd.set("reserveId", reserveId);
    fd.set("bankFrom", bankFrom || "");
    fd.set("proofType", proofType || "OTHER");
    if (alphaLink) fd.set("alphaLink", alphaLink);

    if (pdf1) fd.set("pdf1", pdf1, pdf1.name || "check.pdf");
    if (pdf2) fd.set("pdf2", pdf2, pdf2.name || "stmt.pdf");
    if (video) fd.set("video", video, video.name || "video.mp4");

    const res = await fetch(WORKER_BASE + "/api/public/submit_proof", { method:"POST", body: fd });
    const j = await res.json().catch(()=> ({}));
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  function goCheck(){
    window.location.href = "./check.html?" + new URLSearchParams({ id, reserveId }).toString();
  }

  // ===== Banks list (можно расширять) =====
  const BANKS = [
    "Т-Банк",
    "Совкомбанк",
    "Альфа-Банк",
    "Сбербанк",
    "ВТБ",
    "Газпромбанк",
    "Райффайзенбанк",
    "Росбанк",
    "Открытие",
    "МТС Банк",
    "Уралсиб",
    "Ак Барс Банк",
    "Почта Банк",
    "Другой банк"
  ];

  function initBanks(){
    bankSelect.innerHTML = "";
    for (const b of BANKS){
      const o = document.createElement("option");
      o.value = b;
      o.textContent = b;
      bankSelect.appendChild(o);
    }

    // если банк передали параметром
    const preBank = (p.get("bankFrom") || "").trim();
    if (preBank){
      const npre = normalizeBankName(preBank);
      let best = null;
      for (const opt of bankSelect.options){
        if (normalizeBankName(opt.value) === npre){ best = opt.value; break; }
      }
      if (best) bankSelect.value = best;
    }

    onBankChange();
    bankSelect.onchange = onBankChange;
  }

  // cancel
  document.getElementById("cancelBtn").onclick = async () => {
    try{
      if (id && reserveId){
        await fetch(WORKER_BASE + "/api/public/cancel_reserve", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ id, reserveId })
        });
      }
    }catch(e){}
    window.location.href = "./buy.html";
  };

  // ===== Button handlers (fixed) =====
  const btnEmailSent = document.getElementById("btnEmailSent");
  const btnSendAlfa  = document.getElementById("btnSendAlfa");
  const btnSendSber  = document.getElementById("btnSendSber");
  const btnSendOther = document.getElementById("btnSendOther");

  btnEmailSent.onclick = async () => {
    setLoading(btnEmailSent, true);
    try{
      await markPaid();
      // без файлов — просто создаём checkInfo и переводим в ON_CHECK
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "EMAIL",
        alphaLink: ""
      });
      setStatus("Готово ✅ Отправлено на проверку.", "ok");
      goCheck();
    }catch(e){
      setStatus("Ошибка: " + (e.message || String(e)), "bad");
    }finally{
      setLoading(btnEmailSent, false);
    }
  };

  btnSendAlfa.onclick = async () => {
    setLoading(btnSendAlfa, true);
    try{
      await markPaid();
      const alphaLink = (document.getElementById("alphaLink").value || "").trim();
      const pdf = document.getElementById("alfaPdf").files[0];
      if (!alphaLink) throw new Error("Вставь ссылку “разделение платежа”");
      if (!pdf) throw new Error("Выбери PDF чек");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "ALFA",
        alphaLink,
        pdf1: pdf
      });
      setStatus("Готово ✅ Отправлено на проверку.", "ok");
      goCheck();
    }catch(e){
      setStatus("Ошибка: " + (e.message || String(e)), "bad");
    }finally{
      setLoading(btnSendAlfa, false);
    }
  };

  btnSendSber.onclick = async () => {
    setLoading(btnSendSber, true);
    try{
      await markPaid();
      const pdf1 = document.getElementById("sberPdf1").files[0];
      const pdf2 = document.getElementById("sberPdf2").files[0];
      if (!pdf1) throw new Error("Выбери PDF чек");
      if (!pdf2) throw new Error("Выбери PDF выписку");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "SBER",
        alphaLink: "",
        pdf1,
        pdf2
      });
      setStatus("Готово ✅ Отправлено на проверку.", "ok");
      goCheck();
    }catch(e){
      setStatus("Ошибка: " + (e.message || String(e)), "bad");
    }finally{
      setLoading(btnSendSber, false);
    }
  };

  btnSendOther.onclick = async () => {
    setLoading(btnSendOther, true);
    try{
      await markPaid();
      const vid = document.getElementById("otherVideo").files[0];
      if (!vid) throw new Error("Выбери видео");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "VIDEO_ONLY",
        alphaLink: "",
        video: vid
      });
      setStatus("Готово ✅ Отправлено на проверку.", "ok");
      goCheck();
    }catch(e){
      setStatus("Ошибка: " + (e.message || String(e)), "bad");
    }finally{
      setLoading(btnSendOther, false);
    }
  };

  // init
  (function(){
    initHeader();
    initBanks();

    if (!id || !reserveId){
      setStatus("Ошибка: Missing id / reserveId", "bad");
    } else {
      setStatus("Выберите банк и загрузите подтверждение.", "warn");
    }
  })();
</script>
</body>
</html>
