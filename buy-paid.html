<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>P2P · Подтверждение оплаты</title>

  <style>
    :root{
      --text:#e9f0ff;
      --muted:#9fb0d4;

      --card: rgba(15, 26, 48, 0.52);
      --border: rgba(255,255,255,.12);

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --btn:#2d5bff;
      --btn2:#1f3fb3;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 20px;

      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    *,*::before,*::after{ box-sizing:border-box; }

    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      background:#071022;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }

    /* ✅ красивый фон */
    .overlay{
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(1100px 700px at 50% -220px, rgba(45,91,255,.22), rgba(0,0,0,0) 65%),
        radial-gradient(900px 600px at 85% 85%, rgba(245,158,11,.10), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(7,16,34,.84), rgba(7,16,34,.94));
      pointer-events:none;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:
        calc(18px + env(safe-area-inset-top))
        16px
        calc(22px + env(safe-area-inset-bottom))
        16px;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }

    /* ✅ маленькая “живая” анимация возле заголовка */
    .title{
      font-weight:1000;
      font-size:16px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .liveDot{
      width:10px; height:10px;
      border-radius:999px;
      background: rgba(34,197,94,.95);
      box-shadow: 0 0 0 0 rgba(34,197,94,.35);
      animation: dotPulse 1.25s ease-in-out infinite;
      flex: 0 0 auto;
    }
    @keyframes dotPulse{
      0%{ box-shadow: 0 0 0 0 rgba(34,197,94,.35); transform: scale(1); }
      60%{ box-shadow: 0 0 0 12px rgba(34,197,94,0); transform: scale(1.05); }
      100%{ box-shadow: 0 0 0 0 rgba(34,197,94,0); transform: scale(1); }
    }

    .card{
      position:relative;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
      margin-bottom:14px;
    }
    /* ✅ свечение как на “крутых” страницах */
    .card::before{
      content:"";
      position:absolute;
      inset:-60px;
      background:
        radial-gradient(520px 180px at 35% 20%, rgba(45,91,255,.18), rgba(0,0,0,0) 60%),
        radial-gradient(520px 180px at 75% 90%, rgba(34,197,94,.10), rgba(0,0,0,0) 60%);
      filter: blur(18px);
      pointer-events:none;
      z-index:0;
    }
    .card > *{ position:relative; z-index:1; }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    @media(max-width:900px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media(max-width:520px){
      .grid{ grid-template-columns: 1fr; }
    }

    .cell{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      overflow:hidden;
    }
    .label{ color:var(--muted); font-size:12px; font-weight:950; margin-bottom:6px; }
    .value{ font-weight:1000; font-size:16px; word-break:break-word; }

    .hint{
      color: rgba(233,240,255,.78);
      font-size:12px;
      font-weight:850;
      line-height:1.45;
    }

    label{
      display:block;
      margin-bottom:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:950;
    }

    select, input[type="text"], input[type="file"]{
      width:100%;
      max-width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:12px 12px;
      outline:none;
      font-weight:900;
      font-size:14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .block{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }

    .btnRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .btn{
      border:0;
      border-radius:14px;
      padding:12px 18px;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,.30);
      position:relative;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:disabled{ opacity:.7; cursor:not-allowed; box-shadow:none; }

    .btnGhost{
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px 18px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
      box-shadow:none;
      position:relative;
    }
    .btnGhost:hover{ background: rgba(255,255,255,.09); }

    /* ✅ анимация на кнопке во время отправки */
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .loading{
      pointer-events:none;
      opacity:.85;
    }
    .loading::after{
      content:"";
      position:absolute;
      top:50%;
      right:12px;
      width:16px;
      height:16px;
      margin-top:-8px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      animation: spin .9s linear infinite;
    }

    .status{
      margin-top:12px;
      border-radius:14px;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      font-weight:950;
      font-size:13px;
      white-space:pre-line;
      display:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .status.show{ display:block; }
    .status.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .status.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .status.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }

    @media(max-width:760px){
      .wrap{ padding-top: calc(14px + env(safe-area-inset-top)); }
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <div class="wrap">
    <div class="topRow">
      <div class="title">
        <span class="liveDot"></span>
        Crossflag Exchange · Подтверждение оплаты
      </div>
      <button class="btn" id="backBtn">Назад</button>
    </div>

    <div class="card">
      <div class="grid">
        <div class="cell">
          <div class="label">Ордер</div>
          <div class="value" id="oid">—</div>
        </div>
        <div class="cell">
          <div class="label">Сумма (RUB)</div>
          <div class="value" id="amount">—</div>
        </div>
        <div class="cell">
          <div class="label">Курс</div>
          <div class="value" id="rate">—</div>
        </div>
        <div class="cell">
          <div class="label">Получите</div>
          <div class="value" id="usdt">—</div>
        </div>
      </div>

      <div class="block" style="margin-top:12px;">
        <div class="hint">
          Выберите банк отправителя и загрузите необходимые подтверждения оплаты.
        </div>

        <div style="margin-top:10px;">
          <label>Банк отправителя</label>
          <select id="bankSelect"></select>
        </div>

        <!-- Email -->
        <div class="block" id="blockEmail">
          <div class="hint" style="margin-top:10px;">
            Нужны: <b>PDF чек</b> + <b>PDF выписка</b>.
          </div>
          <div style="margin-top:10px;">
            <label>PDF чек</label>
            <input id="emailPdf1" type="file" accept="application/pdf" />
          </div>
          <div style="margin-top:10px;">
            <label>PDF выписка</label>
            <input id="emailPdf2" type="file" accept="application/pdf" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendEmail">Отправить</button>
          </div>
        </div>

        <!-- Alfa -->
        <div class="block" id="blockAlfa">
          <div class="hint" style="margin-top:10px;">
            Нужны: <b>ссылка “разделение платежа”</b> + <b>PDF чек</b>.
          </div>
          <div style="margin-top:10px;">
            <label>Ссылка “разделение платежа”</label>
            <input id="alphaLink" type="text" placeholder="вставь ссылку разделения платежа" />
          </div>
          <div style="margin-top:10px;">
            <label>PDF чек</label>
            <input id="alfaPdf" type="file" accept="application/pdf" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendAlfa">Отправить</button>
          </div>
        </div>

        <!-- Sber -->
        <div class="block" id="blockSber">
          <div class="hint" style="margin-top:10px;">
            Нужны: <b>PDF чек</b> + <b>видео</b>.
          </div>
          <div style="margin-top:10px;">
            <label>PDF чек</label>
            <input id="sberPdf" type="file" accept="application/pdf" />
          </div>
          <div style="margin-top:10px;">
            <label>Видео</label>
            <input id="sberVideo" type="file" accept="video/*" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendSber">Отправить</button>
          </div>
        </div>

        <!-- Other -->
        <div class="block" id="blockOther">
          <div class="hint" style="margin-top:10px;">
            Нужны: <b>PDF чек</b> + <b>видео</b>.
          </div>
          <div style="margin-top:10px;">
            <label>PDF чек</label>
            <input id="otherPdf" type="file" accept="application/pdf" />
          </div>
          <div style="margin-top:10px;">
            <label>Видео</label>
            <input id="otherVideo" type="file" accept="video/*" />
          </div>
          <div class="btnRow">
            <button class="btn" id="btnSendOther">Отправить</button>
          </div>
        </div>

        <div class="status" id="status"></div>

        <div class="btnRow" style="margin-top:14px;">
          <button class="btnGhost" id="cancelBtn">Отменить заявку</button>
        </div>

      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  const p = new URLSearchParams(location.search);
  const id = p.get("id") || "";
  const reserveId = p.get("reserveId") || "";
  const amountRub = Number(p.get("amountRub"));
  const rate = Number(p.get("rate"));
  const method = String(p.get("method") || "");

  const oidEl = document.getElementById("oid");
  const amountEl = document.getElementById("amount");
  const rateEl = document.getElementById("rate");
  const usdtEl = document.getElementById("usdt");
  const statusEl = document.getElementById("status");
  const bankSelect = document.getElementById("bankSelect");

  const blockEmail = document.getElementById("blockEmail");
  const blockAlfa = document.getElementById("blockAlfa");
  const blockSber = document.getElementById("blockSber");
  const blockOther = document.getElementById("blockOther");

  function fmtRub(n){ return Number(n).toLocaleString("ru-RU") + " ₽"; }
  function fmtRate(n){ return Number(n).toLocaleString("ru-RU"); }
  function fmtUsdt(n){ return Number(n).toLocaleString("ru-RU", { maximumFractionDigits: 6 }) + " USDT"; }

  function setStatus(text, kind){
    statusEl.textContent = text;
    statusEl.className = "status show " + (kind || "warn");
  }

  function setLoading(btn, on){
    if (!btn) return;
    if (on){
      btn.classList.add("loading");
      btn.dataset._txt = btn.textContent;
      btn.textContent = "Отправка…";
      btn.disabled = true;
    } else {
      btn.classList.remove("loading");
      if (btn.dataset._txt) btn.textContent = btn.dataset._txt;
      btn.disabled = false;
    }
  }

  function normalizeBankName(s){
    return (s || "")
      .toLowerCase()
      .replace(/ё/g, "е")
      .replace(/[-–—]/g, "-")
      .replace(/\s+/g, " ")
      .trim();
  }

  // 100 банков
  const BANKS_100 = [
    "Сбербанк","Т-банк","Альфа-Банк","ВТБ","Газпромбанк","Россельхозбанк","Райффайзенбанк","Открытие","Совкомбанк","Росбанк",
    "Промсвязьбанк","Московский кредитный банк","ЮниКредит Банк","Банк Санкт-Петербург","Тинькофф","МТС Банк","Ренессанс Банк","ОТП Банк",
    "Уралсиб","Ак Барс Банк","РНКБ","ДОМ.РФ","Хоум Банк","Русский Стандарт","Ситибанк","Абсолют Банк","Экспобанк","ТрансКапиталБанк",
    "СМП Банк","Кредит Европа Банк","МСП Банк","Банк Зенит","Банк УБРиР","Банк Хлынов","Кубань Кредит","Синара","МТС Деньги","ФКБ",
    "Почта Банк","Киви Банк","Банк Нейва","Локо-Банк","Банк Авангард","Банк Левобережный","Банк Центр-Инвест","Банк Приморье","Ингосстрах Банк","Банк Дальневосточный",
    "СДМ-Банк","Энерготрансбанк","Банк Сургутнефтегазбанк","Банк Россия","Банк Точка","Банк Модульбанк","Банк Уралфинанс","Банк Оранжевый","КБ Солидарность","Банк Казани",
    "Новикомбанк","Банк Ставролен","Интерпромбанк","Банк МЕЖТОПЭНЕРГОБАНК","Банк Союз","КБ Восточный","Банк ПСКБ","Банк Венец","Банк Фора-Банк","Банк БКС",
    "Банк Держава","Банк Кубань Кредит","Банк Севергазбанк","Банк Кузнецкий","Банк Сельмашбанк","Банк Норвик Банк","Банк Промтрансбанк","Банк Элита","Банк Финсервис","Банк Экономический Союз",
    "Банк Кошелев","Банк Агророс","Банк Аресбанк","Банк Таврический","Банк Финам","Банк Братский АНКБ","Банк Уралпромбанк","Банк Челиндбанк","Банк Тимер Банк","Банк Кредит Урал Банк",
    "Банк СЭБ","Банк Промсвязь","Банк Кольцо Урала","Банк ИТБ","Банк Металлинвестбанк","Банк СКБ","Банк Глобэкс","Банк Уралбанк","Банк Хакасский","Банк Снежинский"
  ];

  const SPECIAL = {
    email: ["тинькофф", "t-банк", "т-банк", "t bank", "tbank", "тиньк", "тинькoff"],
    alfa: ["альфа", "alfa", "alpha"],
    sber: ["сбер", "sber", "sberbank", "сбербанк"]
  };

  function detectFlow(bankName){
    const n = normalizeBankName(bankName);
    const any = (arr) => arr.some(x => n.includes(normalizeBankName(x)));
    if (any(SPECIAL.email)) return "EMAIL";
    if (any(SPECIAL.alfa)) return "ALFA";
    if (any(SPECIAL.sber)) return "SBER";
    return "OTHER";
  }

  function showFlow(flow){
    blockEmail.style.display = (flow==="EMAIL") ? "block" : "none";
    blockAlfa.style.display  = (flow==="ALFA")  ? "block" : "none";
    blockSber.style.display  = (flow==="SBER")  ? "block" : "none";
    blockOther.style.display = (flow==="OTHER") ? "block" : "none";
  }

  function setHeader(){
    oidEl.textContent = id || "—";
    amountEl.textContent = Number.isFinite(amountRub) ? fmtRub(amountRub) : "—";
    rateEl.textContent = (Number.isFinite(rate) && rate>0) ? fmtRate(rate) : "—";
    usdtEl.textContent = (Number.isFinite(amountRub) && Number.isFinite(rate) && rate>0) ? fmtUsdt(amountRub / rate) : "—";
  }

  function goBack(){
    const qs = new URLSearchParams({
      id, amountRub: String(amountRub), rate: String(rate), method: String(method), reserveId
    });
    window.location.href = "./crossflag-buy-order.html?" + qs.toString();
  }

  document.getElementById("backBtn").onclick = (e) => { e.preventDefault(); goBack(); };

  async function apiJson(path, method="GET", body=null){
    const res = await fetch(WORKER_BASE + path, {
      method,
      headers: { "Content-Type":"application/json" },
      body: body ? JSON.stringify(body) : null
    });
    const j = await res.json().catch(()=> ({}));
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  async function markPaid(){
    await apiJson("/api/public/mark_paid", "POST", { id, reserveId });
  }

  async function submitMultipart({ bankFrom, proofType, alphaLink, pdf1, pdf2, video }){
    const fd = new FormData();
    fd.set("id", id);
    fd.set("reserveId", reserveId);
    fd.set("bankFrom", bankFrom || "");
    fd.set("proofType", proofType || "OTHER");
    if (alphaLink) fd.set("alphaLink", alphaLink);
    if (pdf1) fd.set("pdf1", pdf1, pdf1.name || "check.pdf");
    if (pdf2) fd.set("pdf2", pdf2, pdf2.name || "stmt.pdf");
    if (video) fd.set("video", video, video.name || "video.mp4");

    const res = await fetch(WORKER_BASE + "/api/public/submit_proof", { method:"POST", body: fd });
    const j = await res.json().catch(()=> ({}));
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  // ===== UI wiring =====
  function fillBanks(){
    bankSelect.innerHTML = "";
    for (const b of BANKS_100){
      const o = document.createElement("option");
      o.value = b;
      o.textContent = b;
      bankSelect.appendChild(o);
    }
    const flow = detectFlow(bankSelect.value);
    showFlow(flow);
  }

  bankSelect.onchange = () => showFlow(detectFlow(bankSelect.value));

  document.getElementById("cancelBtn").onclick = async () => {
    try{
      await apiJson("/api/public/cancel_reserve", "POST", { id, reserveId });
    }catch(e){}
    window.location.href = "./buy.html";
  };

  const btnSendEmail = document.getElementById("btnSendEmail");
  const btnSendAlfa = document.getElementById("btnSendAlfa");
  const btnSendSber = document.getElementById("btnSendSber");
  const btnSendOther = document.getElementById("btnSendOther");

  btnSendEmail.onclick = async () => {
    setLoading(btnSendEmail, true);
    try{
      await markPaid();
      const pdf1 = document.getElementById("emailPdf1").files[0];
      const pdf2 = document.getElementById("emailPdf2").files[0];
      if (!pdf1) throw new Error("Выбери PDF чек");
      if (!pdf2) throw new Error("Выбери PDF выписку");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "EMAIL",
        pdf1, pdf2
      });
      setStatus("Отправлено ✅\nОжидайте проверку.", "ok");
    }catch(e){
      setStatus("Ошибка: " + e.message, "bad");
    }finally{
      setLoading(btnSendEmail, false);
    }
  };

  btnSendAlfa.onclick = async () => {
    setLoading(btnSendAlfa, true);
    try{
      await markPaid();
      const alphaLink = String(document.getElementById("alphaLink").value || "").trim();
      const pdf = document.getElementById("alfaPdf").files[0];
      if (!alphaLink) throw new Error("Вставь ссылку “разделение платежа”");
      if (!pdf) throw new Error("Выбери PDF чек");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "ALFA",
        alphaLink,
        pdf1: pdf
      });
      setStatus("Отправлено ✅\nОжидайте проверку.", "ok");
    }catch(e){
      setStatus("Ошибка: " + e.message, "bad");
    }finally{
      setLoading(btnSendAlfa, false);
    }
  };

  btnSendSber.onclick = async () => {
    setLoading(btnSendSber, true);
    try{
      await markPaid();
      const pdf = document.getElementById("sberPdf").files[0];
      const vid = document.getElementById("sberVideo").files[0];
      if (!pdf) throw new Error("Выбери PDF чек");
      if (!vid) throw new Error("Выбери видео");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "SBER",
        pdf1: pdf,
        video: vid
      });
      setStatus("Отправлено ✅\nОжидайте проверку.", "ok");
    }catch(e){
      setStatus("Ошибка: " + e.message, "bad");
    }finally{
      setLoading(btnSendSber, false);
    }
  };

  btnSendOther.onclick = async () => {
    setLoading(btnSendOther, true);
    try{
      await markPaid();
      const pdf = document.getElementById("otherPdf").files[0];
      const vid = document.getElementById("otherVideo").files[0];
      if (!pdf) throw new Error("Выбери PDF чек");
      if (!vid) throw new Error("Выбери видео");
      await submitMultipart({
        bankFrom: bankSelect.value,
        proofType: "OTHER",
        pdf1: pdf,
        video: vid
      });
      setStatus("Отправлено ✅\nОжидайте проверку.", "ok");
    }catch(e){
      setStatus("Ошибка: " + e.message, "bad");
    }finally{
      setLoading(btnSendOther, false);
    }
  };

  // init
  setHeader();
  fillBanks();

  if (!id || !reserveId){
    setStatus("Ошибка: Missing id / reserveId", "bad");
  } else {
    setStatus("Выберите банк и загрузите подтверждение оплаты.", "warn");
  }
</script>
</body>
</html>
