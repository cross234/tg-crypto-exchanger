<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crossflag · Оплата</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --border:#223255; --text:#e9f0ff;
      --muted:#9fb0d4; --ok:#9dffb8; --bad:#ffb4b4; --btn:#2563eb; --danger:#ef4444;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:18px; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .title{ font-size:16px; font-weight:950; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; }
    .pad{ padding:16px; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    .cell{ border:1px solid var(--border); border-radius:14px; padding:12px; background:rgba(255,255,255,.02); }
    .k{ color:var(--muted); font-size:12px; margin-bottom:4px; }
    .v{ font-weight:850; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; letter-spacing:.2px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .status{ font-size:12px; color:var(--muted); }
    .status.ok{ color:var(--ok); }
    .status.bad{ color:var(--bad); }
    .hr{ height:1px; background:rgba(255,255,255,.08); }
    .btns{ display:flex; gap:10px; justify-content:flex-end; padding:16px; }
    button{
      border:0; border-radius:14px; padding:12px 16px; font-weight:900; cursor:pointer;
      color:white; background:var(--btn);
    }
    button.danger{ background:var(--danger); }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    .copy{
      display:flex; gap:10px; align-items:center;
    }
    .copy button{ padding:8px 12px; border-radius:12px; font-weight:900; }
    .hint{ color:var(--muted); font-size:12px; margin-top:10px; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="title">Crossflag Exchange · Оплата</div>
  </div>

  <div class="card">
    <div class="pad">
      <div class="grid">
        <div class="cell">
          <div class="k">Ордер</div>
          <div class="v mono" id="oid">—</div>
        </div>
        <div class="cell">
          <div class="k">Сумма к оплате (RUB)</div>
          <div class="v" id="amount">—</div>
        </div>
        <div class="cell">
          <div class="k">Курс (RUB/USDT)</div>
          <div class="v" id="rate">—</div>
        </div>
        <div class="cell">
          <div class="k">Получите (USDT)</div>
          <div class="v" id="usdt">—</div>
        </div>
      </div>

      <div style="margin-top:12px;" class="row">
        <div class="status" id="state">Статус: —</div>
        <div class="cell" style="padding:8px 12px; border-radius:999px; width:auto;">
          <div class="k" style="margin:0;">Осталось: <span class="v mono" id="timer">—</span></div>
        </div>
      </div>

      <div class="status bad" id="error" style="margin-top:8px; display:none;"></div>
    </div>

    <div class="hr"></div>

    <div class="pad">
      <div class="v" style="margin-bottom:10px;">Реквизиты для оплаты</div>

      <div class="grid">
        <div class="cell">
          <div class="k">Банк</div>
          <div class="v" id="bank">—</div>
        </div>
        <div class="cell">
          <div class="k">Реквизиты (СБП/карта)</div>
          <div class="row">
            <div class="v mono" id="req" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:420px;">—</div>
            <div class="copy">
              <button id="copyBtn" type="button">Копировать</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hint">Переведи точную сумму и нажми “Я оплатил”.</div>
    </div>

    <div class="btns">
      <button class="danger" id="cancelBtn" type="button">Отменить ордер</button>
      <button id="paidBtn" type="button">Я оплатил</button>
    </div>
  </div>
</div>

<script>
  const WORKER_BASE = "https://rapira-rates-proxy.kireeshka73.workers.dev";

  const qs = new URLSearchParams(location.search);
  const id = qs.get("id") || "";
  const amountRub = Number(qs.get("amountRub"));
  const rate = Number(qs.get("rate"));
  const method = String(qs.get("method") || "");

  const oidEl = document.getElementById("oid");
  const amountEl = document.getElementById("amount");
  const rateEl = document.getElementById("rate");
  const usdtEl = document.getElementById("usdt");
  const bankEl = document.getElementById("bank");
  const reqEl = document.getElementById("req");
  const stateEl = document.getElementById("state");
  const timerEl = document.getElementById("timer");
  const errEl = document.getElementById("error");

  const copyBtn = document.getElementById("copyBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const paidBtn = document.getElementById("paidBtn");

  let reserveId = "";
  let reservedUntil = 0; // ms timestamp
  let timerHandle = null;
  let finished = false;

  function fmtRub(n){
    const v = Number(n);
    if (!Number.isFinite(v)) return "—";
    return v.toLocaleString("ru-RU") + " ₽";
  }
  function fmtNum(n){
    const v = Number(n);
    if (!Number.isFinite(v)) return "—";
    return v.toLocaleString("ru-RU", { maximumFractionDigits: 6 });
  }
  function setState(text){
    stateEl.textContent = "Статус: " + text;
  }
  function setStatus(text, kind=""){
    errEl.style.display = text ? "block" : "none";
    errEl.textContent = text || "";
    errEl.className = "status " + (kind || "");
  }

  function reserveLocalKey(){ return "cf_reserve_" + id; }
  function saveReserveLocal(reserveId, expiresAt){
    localStorage.setItem(reserveLocalKey(), JSON.stringify({ reserveId, expiresAt, savedAt: Date.now() }));
  }
  function readReserveLocal(){
    try{ return JSON.parse(localStorage.getItem(reserveLocalKey()) || "null"); }catch{ return null; }
  }
  function clearReserveLocal(){ localStorage.removeItem(reserveLocalKey()); }

  async function postJson(path, body){
    const res = await fetch(WORKER_BASE + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch { throw new Error("Worker вернул не JSON: " + text.slice(0, 200)); }
    if (!res.ok || !j.ok) throw new Error(j.error || ("HTTP " + res.status));
    return j;
  }

  function updateTimer(){
    const left = Math.max(0, reservedUntil - Date.now());
    const sec = Math.floor(left / 1000);
    const mm = String(Math.floor(sec / 60)).padStart(2, "0");
    const ss = String(sec % 60).padStart(2, "0");
    timerEl.textContent = `${mm}:${ss}`;

    if (left <= 0) {
      timerEl.textContent = "00:00";
      autoCancelDueToTimeout();
    }
  }

  async function startReserve(){
    if (!id) {
      setState("Ошибка");
      setStatus("Ошибка: отсутствует id", "bad");
      return;
    }

    oidEl.textContent = id;
    amountEl.textContent = fmtRub(amountRub);
    rateEl.textContent = fmtNum(rate);
    const usdt = (Number(amountRub) && Number(rate)) ? (Number(amountRub) / Number(rate)) : NaN;
    usdtEl.textContent = Number.isFinite(usdt) ? (fmtNum(usdt) + " USDT") : "—";

    // Пытаемся восстановить резерв после обновления страницы
    const cached = readReserveLocal();
    if (cached && cached.reserveId && Number(cached.expiresAt) > Date.now()) {
      try{
        setState("Ожидание оплаты");
        setStatus("Восстанавливаю сделку после обновления…");
        const j = await postJson("/api/public/reserve_offer", { id, reserveId: cached.reserveId });

        reserveId = j.reserveId;
        reservedUntil = j.expiresAt;

        bankEl.textContent = j.offer?.payBank || "—";
        reqEl.textContent = j.offer?.payRequisite || "—";

        saveReserveLocal(reserveId, reservedUntil);

        setState("Ожидание оплаты");
        setStatus("Сделка восстановлена. Нажми “Я оплатил” после перевода.", "ok");
        updateTimer();
        timerHandle = setInterval(updateTimer, 1000);
        return;
      } catch {
        clearReserveLocal();
      }
    }

    // Новый резерв
    try{
      setState("Резервирую…");
      setStatus("Загружаю реквизиты и резервирую заявку…");

      const j = await postJson("/api/public/reserve_offer", { id });

      reserveId = j.reserveId;
      reservedUntil = j.expiresAt;

      bankEl.textContent = j.offer?.payBank || "—";
      reqEl.textContent = j.offer?.payRequisite || "—";

      saveReserveLocal(reserveId, reservedUntil);

      setState("Ожидание оплаты");
      setStatus("Заявка зарезервирована на 15 минут. Оплати и нажми “Я оплатил”.", "ok");
      updateTimer();
      timerHandle = setInterval(updateTimer, 1000);
    } catch(e){
      setState("Ошибка");
      setStatus("Ошибка: " + e.message, "bad");
    }
  }

  async function autoCancelDueToTimeout(){
    if (finished) return;
    finished = true;
    if (timerHandle) clearInterval(timerHandle);
    setState("Отменено");
    setStatus("Время оплаты истекло. Ордер отменён, заявка разморожена.", "bad");

    try{
      if (reserveId) await postJson("/api/public/cancel_reserve", { id, reserveId });
    }catch{}
    clearReserveLocal();
    paidBtn.disabled = true;
    cancelBtn.disabled = true;
  }

  copyBtn.onclick = async () => {
    try{
      const txt = (reqEl.textContent || "").trim();
      if (!txt || txt === "—") return;
      await navigator.clipboard.writeText(txt);
      setStatus("Скопировано ✅", "ok");
      setTimeout(() => setStatus("", ""), 1200);
    }catch{}
  };

  cancelBtn.onclick = async () => {
    if (finished) return;
    finished = true;
    if (timerHandle) clearInterval(timerHandle);

    cancelBtn.disabled = true;
    paidBtn.disabled = true;

    try{
      setState("Отменяю…");
      await postJson("/api/public/cancel_reserve", { id, reserveId });
      setState("Отменено");
      setStatus("Ордер отменён, заявка разморожена.", "ok");
    } catch(e){
      setState("Ошибка");
      setStatus("Ошибка: " + e.message, "bad");
    }
    clearReserveLocal();
  };

  paidBtn.onclick = async () => {
    if (finished) return;
    paidBtn.disabled = true;

    try{
      setState("Подтверждаю оплату…");
      await postJson("/api/public/mark_paid", { id, reserveId });
      setState("Оплачено");
      setStatus("Отлично. Теперь отправь подтверждение оплаты.", "ok");

      // Переход на страницу загрузки пруфов
      const p = new URLSearchParams({
        id,
        reserveId,
        amountRub: String(amountRub),
        rate: String(rate),
        method: String(method || ""),
      });
      location.href = "./buy-paid.html?" + p.toString();
    } catch(e){
      paidBtn.disabled = false;
      setState("Ошибка");
      setStatus("Ошибка: " + e.message, "bad");
    }
  };

  startReserve();
</script>
</body>
</html>
